---
phase: 08-terrain-themes
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - AirplaneTracker3D/Rendering/ThemeManager.swift
  - AirplaneTracker3D/Rendering/AirportLabelManager.swift
  - AirplaneTracker3D/Data/airports.json
  - AirplaneTracker3D/Rendering/Renderer.swift
  - AirplaneTracker3D/Rendering/Shaders.metal
  - AirplaneTracker3D/Map/MapTileManager.swift
  - AirplaneTracker3D/ContentView.swift
autonomous: true

must_haves:
  truths:
    - "User can switch between three themes (day, night, retro) and the entire scene updates: sky color, ground, aircraft, trails, labels, and airport labels"
    - "Day theme shows light map tiles (CartoDB Positron) with sky blue background and solid rendering"
    - "Night theme shows dark map tiles (CartoDB Dark Matter) with dark blue background and solid rendering"
    - "Retro theme shows green wireframe terrain and aircraft with dark green background, setTriangleFillMode(.lines)"
    - "User sees 3D text labels on the ground for nearby major airports that remain readable as the camera moves"
  artifacts:
    - path: "AirplaneTracker3D/Rendering/ThemeManager.swift"
      provides: "Theme enum, ThemeConfig struct, and color palettes for all three themes"
      contains: "enum Theme"
    - path: "AirplaneTracker3D/Rendering/AirportLabelManager.swift"
      provides: "Airport data loading, distance-culled label rendering on ground plane"
      contains: "class AirportLabelManager"
    - path: "AirplaneTracker3D/Data/airports.json"
      provides: "Embedded database of ~500 major airports with IATA, lat, lon"
      contains: "icao"
    - path: "AirplaneTracker3D/Rendering/Renderer.swift"
      provides: "Theme-aware rendering for all passes, airport label draw calls"
      contains: "themeManager"
    - path: "AirplaneTracker3D/Map/MapTileManager.swift"
      provides: "Theme-aware tile URL switching with cache clear on theme change"
      contains: "tileURL.*theme"
    - path: "AirplaneTracker3D/ContentView.swift"
      provides: "Theme toggle button in UI"
      contains: "Theme"
  key_links:
    - from: "AirplaneTracker3D/ContentView.swift"
      to: "AirplaneTracker3D/Rendering/Renderer.swift"
      via: "NotificationCenter theme change notification"
      pattern: "themeChanged"
    - from: "AirplaneTracker3D/Rendering/Renderer.swift"
      to: "AirplaneTracker3D/Rendering/ThemeManager.swift"
      via: "themeManager.current provides colors and wireframe mode"
      pattern: "themeManager\\.current"
    - from: "AirplaneTracker3D/Rendering/ThemeManager.swift"
      to: "AirplaneTracker3D/Map/MapTileManager.swift"
      via: "Theme change triggers cache clear and URL switch"
      pattern: "clearCache"
    - from: "AirplaneTracker3D/Rendering/AirportLabelManager.swift"
      to: "AirplaneTracker3D/Data/airports.json"
      via: "Bundle.main.url loading at init"
      pattern: "airports.*json"
---

<objective>
Build the theme system with three visual modes (day/night/retro) that affects every render pass, and add airport ground labels from an embedded database of major airports.

Purpose: Themes give the app visual personality and mood. Day is clean and bright, night is atmospheric, retro is distinctive vector-graphics style. Airport labels provide geographic context -- users can see where major airports are located relative to aircraft.
Output: ThemeManager.swift, AirportLabelManager.swift, airports.json, updated Renderer.swift, MapTileManager.swift, Shaders.metal, ContentView.swift
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-terrain-themes/08-RESEARCH.md
@.planning/phases/08-terrain-themes/08-01-SUMMARY.md

@AirplaneTracker3D/Rendering/Renderer.swift
@AirplaneTracker3D/Rendering/ShaderTypes.h
@AirplaneTracker3D/Rendering/Shaders.metal
@AirplaneTracker3D/Rendering/LabelManager.swift
@AirplaneTracker3D/Rendering/AircraftInstanceManager.swift
@AirplaneTracker3D/Rendering/TrailManager.swift
@AirplaneTracker3D/Map/MapTileManager.swift
@AirplaneTracker3D/ContentView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: ThemeManager, theme-aware tile URLs, and retro fragment shader</name>
  <files>
    AirplaneTracker3D/Rendering/ThemeManager.swift
    AirplaneTracker3D/Map/MapTileManager.swift
    AirplaneTracker3D/Rendering/Shaders.metal
  </files>
  <action>
1. Create ThemeManager.swift with the theme system:

   **Theme enum:**
   ```swift
   enum Theme: String, CaseIterable {
       case day, night, retro
   }
   ```

   **ThemeConfig struct** (pure data, no MTL references):
   ```swift
   struct ThemeConfig {
       let clearColor: (r: Double, g: Double, b: Double)
       let placeholderColor: SIMD4<Float>
       let isWireframe: Bool
       let aircraftTint: SIMD4<Float>    // white for day/night, green for retro
       let trailTint: SIMD4<Float>       // white for day/night, green for retro
       let labelTextColor: NSColor       // for CoreText rasterization
       let labelBgColor: NSColor
       let airportLabelColor: SIMD4<Float>
       let altLineColor: SIMD4<Float>
   }
   ```

   **ThemeManager class:**
   - `var current: Theme = .day` with didSet that posts `.themeChanged` notification and calls `onThemeChanged?(current)` callback
   - `var config: ThemeConfig { configs[current] }` computed property
   - Static config dictionaries for each theme with EXACT colors from research:
     - **Day:** clearColor (0.529, 0.808, 0.922), placeholder (0.831, 0.867, 0.831, 1.0), wireframe=false, aircraftTint=white, trailTint=white, labelText=white, labelBg=black@0.6, airportLabel=(0.0, 0.4, 0.8, 1.0), altLine=(0.5, 0.5, 0.5, 0.3)
     - **Night:** clearColor (0.039, 0.039, 0.102), placeholder (0.102, 0.165, 0.227, 1.0), wireframe=false, aircraftTint=white, trailTint=white, labelText=cyan, labelBg=darkBlue@0.7, airportLabel=(0.4, 0.733, 1.0, 1.0), altLine=(0.5, 0.5, 0.5, 0.3)
     - **Retro:** clearColor (0.0, 0.031, 0.0), placeholder (0.0, 0.067, 0.0, 1.0), wireframe=true, aircraftTint=(0.0, 1.0, 0.0, 1.0), trailTint=(0.0, 1.0, 0.0, 1.0), labelText=green, labelBg=darkGreen@0.6, airportLabel=(0.0, 1.0, 0.0, 1.0), altLine=(0.0, 1.0, 0.0, 0.3)
   - `func cycleTheme()` -- advances to next theme in day->night->retro->day cycle
   - Persist to UserDefaults: save on set, load on init

   **Tile URL function** on ThemeConfig (or as a static on ThemeManager):
   ```swift
   func tileURL(for tile: TileCoordinate, theme: Theme) -> URL
   ```
   - Day: `https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png` (rotate a/b/c subdomains)
   - Night: `https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png` (rotate a/b/c subdomains)
   - Retro: Use OSM tiles (same as current) -- apply green tint in shader. This avoids the Stadia Maps API key requirement.

2. Modify MapTileManager.swift:
   - Add `var currentTheme: Theme = .day` property
   - Change `tileURL(for:)` to use theme-specific URLs (call ThemeManager's URL function or inline the logic):
     - Day: CartoDB Positron `{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png`
     - Night: CartoDB Dark Matter `a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png`
     - Retro: Keep current OSM tiles `{s}.tile.openstreetmap.org/{z}/{x}/{y}.png`
   - Add `func switchTheme(_ theme: Theme)` that sets currentTheme and calls `clearCache()` to flush old-style tiles

3. Add a retro green-tint fragment shader to Shaders.metal:
   ```metal
   fragment float4 fragment_retro_textured(TexturedVertexOut in [[stage_in]],
                                            texture2d<float> colorTexture [[texture(TextureIndexColor)]]) {
       constexpr sampler texSampler(mag_filter::linear, min_filter::linear);
       float4 texColor = colorTexture.sample(texSampler, in.texCoord);
       // Invert and shift to green channel for retro CRT look
       float gray = 1.0 - (texColor.r * 0.3 + texColor.g * 0.59 + texColor.b * 0.11);
       return float4(0.0, gray * 0.8, 0.0, 1.0);
   }
   ```
   Also add `fragment_retro_terrain` that does the same for terrain fragments (invert + green tint + terrain lighting).

   **Important:** Do NOT add a retro terrain vertex shader -- reuse terrain_vertex. Only the fragment changes.
  </action>
  <verify>
Build succeeds with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D build 2>&1 | tail -5`. ThemeManager.swift compiles with three themes. MapTileManager has theme-aware URLs. Retro shader compiles.
  </verify>
  <done>
ThemeManager provides three complete theme configurations with correct color palettes. MapTileManager switches tile URL providers per theme with cache invalidation. Retro green-tint fragment shaders exist for both flat tiles and terrain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Airport ground labels with embedded database</name>
  <files>
    AirplaneTracker3D/Data/airports.json
    AirplaneTracker3D/Rendering/AirportLabelManager.swift
  </files>
  <action>
1. Create the airports.json embedded database in a new `AirplaneTracker3D/Data/` directory. Generate a JSON array of ~100 major world airports (large_airport type) with these fields per entry:
   ```json
   {
     "icao": "KSEA",
     "iata": "SEA",
     "name": "Seattle-Tacoma International Airport",
     "lat": 47.449,
     "lon": -122.309,
     "type": "large_airport"
   }
   ```
   Include a representative set of major airports worldwide: US (JFK, LAX, ORD, ATL, DFW, SFO, SEA, DEN, MIA, BOS, etc.), Europe (LHR, CDG, FRA, AMS, MAD, FCO, etc.), Asia (NRT, HND, PEK, PVG, HKG, SIN, ICN, BKK, etc.), Middle East (DXB, DOH, etc.), Oceania (SYD, MEL, AKL), Africa (JNB, CAI), South America (GRU, EZE, BOG, SCL). About 80-100 airports total -- enough for global coverage without being excessive.

   **CRITICAL:** The airports.json file MUST be added to the Xcode project's Copy Bundle Resources build phase so it is included in the app bundle. Add it via the pbxproj file modification (or note that the executor must ensure it is in the target's resources).

2. Create AirportLabelManager.swift:

   **AirportData struct** (Codable):
   ```swift
   struct AirportData: Codable {
       let icao: String
       let iata: String?
       let name: String
       let lat: Double
       let lon: Double
       let type: String
   }
   ```

   **AirportLabelManager class** (modeled on LabelManager pattern):
   - **Init:** Load airports.json from Bundle.main, decode to [AirportData], pre-compute world-space positions using MapCoordinateSystem (lonToX, latToZ)
   - **Properties:**
     - `airports: [AirportData]` -- loaded from JSON
     - `airportPositions: [SIMD3<Float>]` -- pre-computed world XZ, Y=0.5 (slightly above ground)
     - Atlas: Reuse a SEPARATE texture atlas (1024x512, 128x32 slots = 8x16 = 128 slots) for airport labels -- these are smaller text (just IATA codes like "SEA", "LAX")
     - Triple-buffered instance buffers (LabelInstanceData reused from existing type in ShaderTypes.h)
     - Per-buffer instance counts
   - **Rasterization:** Similar to LabelManager but simpler text (just IATA or ICAO code, single line, smaller font 12pt). Rasterize all airport labels at init time (they never change text). Use the ThemeConfig's airportLabelColor for text color and a semi-transparent dark background.
   - **update(bufferIndex:cameraPosition:themeConfig:):**
     - For each airport, compute distance to camera
     - Large airports: visible within 400 world units
     - Sort by distance, cap at 40 visible labels
     - For visible airports, write LabelInstanceData instances:
       - position = airportPositions[i] (at ground level, Y=0.5)
       - size = 6.0 (slightly smaller than aircraft labels)
       - atlasUV/atlasSize from pre-computed slot coordinates
       - opacity = distance-based fade (full at <200 units, fade to 0 at maxDistance)
     - The labels reuse the existing label_vertex/label_fragment shaders (billboard rendering). They will billboard toward the camera just like aircraft labels but at ground level.

   **Theme awareness:** When theme changes, re-rasterize all airport labels with the new theme's airport label color. Add a `updateTheme(_ config: ThemeConfig)` method that clears and re-rasterizes the atlas.
  </action>
  <verify>
Build succeeds. airports.json exists with valid JSON and 80+ airport entries. AirportLabelManager loads airports and creates atlas. LabelInstanceData output matches the existing label shader input format.
  </verify>
  <done>
Airport ground labels render at world-space positions for ~100 major airports. Labels show IATA codes, are distance-culled (max 40 visible), and fade with distance. Atlas is pre-rasterized at init and re-rasterized on theme change.
  </done>
</task>

<task type="auto">
  <name>Task 3: Renderer theme integration and ContentView theme toggle</name>
  <files>
    AirplaneTracker3D/Rendering/Renderer.swift
    AirplaneTracker3D/ContentView.swift
  </files>
  <action>
1. Modify Renderer.swift to be fully theme-aware:

   **New properties:**
   - `let themeManager = ThemeManager()`
   - `let airportLabelManager: AirportLabelManager`
   - `let retroTexturedPipeline: MTLRenderPipelineState` (flat tiles with retro shader)
   - `let retroTerrainPipeline: MTLRenderPipelineState` (terrain with retro shader)

   **In init(metalView:):**
   - Create airportLabelManager = AirportLabelManager(device: device)
   - Create retroTexturedPipeline using vertex_textured + fragment_retro_textured
   - Create retroTerrainPipeline using terrain_vertex + fragment_retro_terrain (if separate retro terrain fragment exists) or reuse the terrain pipeline with a tint uniform

   **In draw(in:) -- apply theme to every pass:**

   a) **Clear color:** Set from themeManager.config.clearColor instead of hardcoded sky blue:
      ```swift
      let config = themeManager.config
      renderPassDescriptor.colorAttachments[0].clearColor = MTLClearColor(
          red: config.clearColor.r, green: config.clearColor.g, blue: config.clearColor.b, alpha: 1.0
      )
      ```

   b) **Ground tiles (flat fallback):** When in retro mode and using flat tiles, use retroTexturedPipeline. When NOT retro, use texturedPipelineState as before.

   c) **Terrain:** When in retro mode, use retroTerrainPipeline. When NOT retro, use terrainPipeline. For retro mode, also set `encoder.setTriangleFillMode(.lines)` before terrain draw calls, then restore `.fill` after.

   d) **Aircraft:** For retro mode, set `encoder.setTriangleFillMode(.lines)` before aircraft draw calls. This makes aircraft render as wireframe. Restore `.fill` after aircraft and spinning parts are drawn. For the aircraft tint in retro mode, the AircraftInstanceManager should receive the theme tint. The simplest approach: in retro mode, override all aircraft instance colors to green (0, 1, 0, 1) during instanceManager.update(). Add a `tintColor: SIMD4<Float>?` parameter to instanceManager.update() -- when non-nil, multiply instance color by tint.

   e) **Trails:** In retro mode, trail colors should be green. The TrailManager builds trail vertices with altitude-based colors. Add a `tintColor: SIMD4<Float>?` parameter to trailManager.update() -- when non-nil, replace trail vertex colors with green gradient (bright green for high altitude, dark green for low).

   f) **Labels:** LabelManager rasterizes with hardcoded white text. On theme change, labels need re-rasterization with new colors. Add a way to invalidate the label cache in LabelManager so labels get re-rasterized next frame. The simplest approach: add `func invalidateCache()` to LabelManager that clears labelCache and resets slotAllocator. Then on theme change, call labelManager.invalidateCache(). Modify the rasterizeLabel method to accept color parameters, or have LabelManager read from a `textColor`/`bgColor` property that the renderer sets from theme config.

   g) **Altitude lines:** Currently use hardcoded colors in the shader. The altline_fragment shader should use a color passed from the vertex shader. Modify AltLineVertex to include a color field, or set the color in the fragment shader via a buffer. Simplest: add an `altLineColor` member to the Uniforms struct or pass it as a separate buffer. OR: just modify the altitude line vertex data to include the theme color. Since AltLineVertex is small (16 bytes), add a `simd_float4 color` field to make it 32 bytes. Update the altline shaders to pass through this color.

   h) **Glow sprites:** In retro mode, tint glow color green. Same approach as aircraft -- the GlowInstanceData color can be overridden to green in instanceManager.update() when retro tint is active.

   i) **Airport labels:** Call `airportLabelManager.update(bufferIndex:cameraPosition:themeConfig:)` each frame. Encode airport label draw calls after aircraft labels, using the same label_vertex/label_fragment shaders but with the airport label atlas texture.

   **Theme change handling:**
   - Listen for `.themeChanged` notification or wire a callback from ThemeManager
   - On theme change: call `tileManager.switchTheme(newTheme)`, `terrainTileManager.clearCache()` (terrain textures need to reload since they are tinted by the theme fragment shader), `labelManager.invalidateCache()`, `airportLabelManager.updateTheme(config)`
   - NOTE: Terrain MESHES (elevation data) do NOT need to be cleared on theme change -- only the map TEXTURES change. The terrain mesh geometry is theme-independent. So actually, do NOT clear terrainTileManager cache on theme change. Only clear mapTileManager cache.

   **Wireframe mode control:** `setTriangleFillMode(.lines)` applies to terrain and aircraft in retro mode. Restore to `.fill` before drawing trails (triangle strip looks bad in wireframe), labels (billboard quads), glow sprites, altitude lines (already just lines). The order in draw():
   ```
   if retro: encoder.setTriangleFillMode(.lines)
   draw terrain
   draw altitude lines (line primitives, fill mode irrelevant)
   draw aircraft bodies
   draw spinning parts
   if retro: encoder.setTriangleFillMode(.fill)  // restore for everything below
   draw trails
   draw labels
   draw airport labels
   draw glow
   ```

2. Modify ContentView.swift to add a theme toggle:
   - Add a small button in the top-left corner (overlay on ZStack) to cycle themes
   - Button shows current theme icon or text: "DAY" / "NIGHT" / "RETRO"
   - On tap, post `.themeChanged` notification with the new theme as object, or post `.cycleTheme` notification
   - Style the button with a semi-transparent background, rounded corners, small padding
   - Add `.cycleTheme` notification name to the Notification.Name extension
   - The MetalView Coordinator should observe this notification and call `renderer.themeManager.cycleTheme()`, then propagate changes

   **Alternative simpler approach:** Since the Renderer is accessed through the MetalView Coordinator, add a theme cycling method to the Coordinator that the ContentView button triggers via NotificationCenter (same pattern as follow mode). The Coordinator calls renderer.themeManager.cycleTheme() and then handles the cascading updates (clear tile cache, invalidate labels, etc.).
  </action>
  <verify>
Build succeeds with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D build 2>&1 | tail -5`. Run the app:
1. Default theme is day (sky blue background, light map tiles)
2. Click theme toggle -- scene switches to night (dark background, dark tiles)
3. Click again -- retro mode with green wireframe terrain and aircraft, dark green background
4. Click again -- back to day
5. Airport labels visible on ground near major airports (IATA codes like "SEA", "LAX")
6. Airport labels fade with distance, max ~40 visible at once
7. All render passes update with theme colors (trails, labels, glow, altitude lines)
  </verify>
  <done>
Three themes fully integrated into every render pass. Theme toggle works from UI. Airport ground labels show IATA codes for major airports with distance culling. Retro mode uses wireframe rendering for terrain and aircraft. Map tiles switch style per theme. All colors (clear, labels, trails, glow, altitude lines) adapt to current theme.
  </done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D build`
2. Day theme: Sky blue background, light CartoDB tiles, solid terrain and aircraft, blue airport labels
3. Night theme: Dark background, dark CartoDB tiles, solid rendering, light blue airport labels
4. Retro theme: Dark green background, wireframe terrain and aircraft (green), green airport labels, green-tinted map tiles
5. Theme switching: Clicking toggle cycles through all three, map tiles reload with correct style
6. Airport labels: Visible at ground level for nearby major airports, IATA codes readable, distance-culled
7. Performance: 30+ fps maintained across all themes
</verification>

<success_criteria>
- Three themes (day/night/retro) with correct color palettes from research
- Every render pass responds to theme: clear color, terrain, aircraft, trails, labels, glow, altitude lines, airport labels
- Retro uses setTriangleFillMode(.lines) for terrain and aircraft wireframe
- Map tiles switch URL provider per theme with cache invalidation
- Airport ground labels show IATA codes for ~100 major airports
- Airport labels distance-culled to max 40 visible
- Theme persists to UserDefaults across app restarts
- UI button cycles themes
</success_criteria>

<output>
After completion, create `.planning/phases/08-terrain-themes/08-02-SUMMARY.md`
</output>
