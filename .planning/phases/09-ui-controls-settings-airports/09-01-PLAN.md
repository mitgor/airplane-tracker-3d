---
phase: 09-ui-controls-settings-airports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AirplaneTracker3D/Views/AirportSearchPanel.swift
  - AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift
  - AirplaneTracker3D/Camera/FlyToAnimator.swift
  - AirplaneTracker3D/Camera/OrbitCamera.swift
  - AirplaneTracker3D/Rendering/MetalView.swift
  - AirplaneTracker3D/ContentView.swift
autonomous: true

must_haves:
  truths:
    - "User can type in a search field and see airport results filtered by name, IATA, or ICAO code"
    - "User can click an airport result and the camera smoothly animates to that airport's position"
    - "User sees a nearby airports list sorted by distance from the current camera center"
    - "Fly-to animation disengages any active aircraft follow mode before animating"
  artifacts:
    - path: "AirplaneTracker3D/Views/AirportSearchPanel.swift"
      provides: "SwiftUI search panel with TextField, filtered results list, and nearby airports tab"
      min_lines: 80
    - path: "AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift"
      provides: "Search filtering logic, nearby airport computation, and fly-to action dispatch"
      min_lines: 60
    - path: "AirplaneTracker3D/Camera/FlyToAnimator.swift"
      provides: "Smooth ease-in-out camera animation from current position to target world coordinates"
      min_lines: 40
  key_links:
    - from: "AirplaneTracker3D/Views/AirportSearchPanel.swift"
      to: "AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift"
      via: "@StateObject viewModel"
      pattern: "AirportSearchViewModel"
    - from: "AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift"
      to: "NotificationCenter"
      via: "post .flyToAirport notification with world position"
      pattern: "post.*flyToAirport"
    - from: "AirplaneTracker3D/Rendering/MetalView.swift"
      to: "AirplaneTracker3D/Camera/FlyToAnimator.swift"
      via: "Coordinator observes .flyToAirport, starts FlyToAnimator"
      pattern: "flyToAnimator.*startFlyTo"
    - from: "AirplaneTracker3D/Camera/FlyToAnimator.swift"
      to: "AirplaneTracker3D/Camera/OrbitCamera.swift"
      via: "update() drives camera.target and camera.distance each frame"
      pattern: "camera\\.target.*camera\\.distance"
---

<objective>
Airport search panel with autocomplete, fly-to camera animation, and nearby airports browsing.

Purpose: Enables airport discovery -- users can find airports by code or name, fly the camera to any airport with a smooth animation, and browse what airports are near their current view. This is the spatial navigation layer of the app.

Output: AirportSearchPanel.swift, AirportSearchViewModel.swift, FlyToAnimator.swift, plus wiring into ContentView and MetalView Coordinator.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-controls-settings-airports/09-RESEARCH.md
@AirplaneTracker3D/ContentView.swift
@AirplaneTracker3D/Camera/OrbitCamera.swift
@AirplaneTracker3D/Rendering/MetalView.swift
@AirplaneTracker3D/Rendering/AirportLabelManager.swift
@AirplaneTracker3D/Views/AircraftDetailPanel.swift
@AirplaneTracker3D/Map/MapCoordinateSystem.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: FlyToAnimator + AirportSearchViewModel + AirportSearchPanel</name>
  <files>
    AirplaneTracker3D/Camera/FlyToAnimator.swift
    AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift
    AirplaneTracker3D/Views/AirportSearchPanel.swift
  </files>
  <action>
Create three new files:

**FlyToAnimator.swift** (in Camera/):
- `final class FlyToAnimator` with properties: `isAnimating: Bool`, `startTarget: SIMD3<Float>`, `endTarget: SIMD3<Float>`, `startDistance: Float`, `endDistance: Float`, `elapsed: Float`, `duration: Float = 2.0`
- `func startFlyTo(from camera: OrbitCamera, to worldPosition: SIMD3<Float>)` -- captures start state from camera, sets end target to worldPosition, endDistance to `min(camera.distance, 80)`, resets elapsed to 0, sets isAnimating true
- `func update(camera: inout OrbitCamera, deltaTime: Float)` -- guard isAnimating, increment elapsed, compute `t = min(elapsed/duration, 1.0)`, apply smoothstep `t * t * (3.0 - 2.0 * t)`, lerp `camera.target` and `camera.distance`, set isAnimating false when t >= 1.0
- Note: FlyToAnimator does NOT own the camera. It receives the camera reference and mutates target/distance. Since OrbitCamera is a class, pass it directly (not inout -- just `camera: OrbitCamera`).

**AirportSearchViewModel.swift** (create ViewModels/ directory):
- `@MainActor final class AirportSearchViewModel: ObservableObject`
- Published properties: `searchText: String = ""`, `showNearby: Bool = true`
- Computed `filteredAirports: [AirportData]` -- when searchText is empty return []; otherwise filter AirportLabelManager's static airport list by lowercased name/iata/icao containing query, capped at 10 results
- Computed `nearbyAirports: [(airport: AirportData, distance: Float)]` -- sort airports by XZ world-space Euclidean distance from `cameraTarget`, return top 10. Uses MapCoordinateSystem.shared to convert airport lat/lon to world XZ, then computes distance from `cameraTarget.x/z`.
- Property `cameraTarget: SIMD3<Float> = .zero` -- updated periodically from outside
- `func flyTo(airport: AirportData)` -- compute world position via MapCoordinateSystem.shared (lonToX, latToZ), Y = 0.5, post `.flyToAirport` notification with the SIMD3<Float> world position as the object (wrap in NSValue or use userInfo dict with "position" key as [Float] array since NSNotification objects must be AnyObject). Clear searchText after posting.
- Store a reference to the airports array. Load it from airports.json in init (same loading pattern as AirportLabelManager.loadAirports -- decode [AirportData] from Bundle). Pre-lowercase name/iata/icao into a parallel array for fast search.

**AirportSearchPanel.swift** (in Views/):
- `struct AirportSearchPanel: View` with `@StateObject private var viewModel = AirportSearchViewModel()`
- Two modes via a segmented Picker at top: "Search" and "Nearby"
- Search mode: TextField("Search airports...", text: $viewModel.searchText) with .textFieldStyle(.roundedBorder), below it a ScrollView of filtered results. Each result row shows IATA/ICAO code in monospaced bold + airport name in caption. Tapping a row calls viewModel.flyTo(airport:).
- Nearby mode: ScrollView list of viewModel.nearbyAirports, each row shows IATA/ICAO code + name + distance formatted as world units (no conversion needed, just show relative). Tapping flies to that airport.
- Style: match AircraftDetailPanel -- dark background (Color.black.opacity(0.85)), rounded corners, white text, .frame(width: 260). Use .allowsHitTesting(true) only on the panel itself.
- Add a close button (X) at top-right that posts `.toggleSearch` notification.
  </action>
  <verify>
Build succeeds: `cd /Users/mit/Documents/GitHub/airplane-tracker-3d && xcodebuild build -scheme AirplaneTracker3D -destination 'platform=macOS' 2>&1 | tail -5`

Verify files exist and have content:
- `wc -l AirplaneTracker3D/Camera/FlyToAnimator.swift` shows 40+ lines
- `wc -l AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift` shows 60+ lines
- `wc -l AirplaneTracker3D/Views/AirportSearchPanel.swift` shows 80+ lines
  </verify>
  <done>
FlyToAnimator provides smooth camera animation via smoothstep interpolation. AirportSearchViewModel filters airports by name/IATA/ICAO and computes nearby airports by distance. AirportSearchPanel renders search + nearby tabs with dark themed UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire search panel into ContentView and FlyToAnimator into MetalView Coordinator</name>
  <files>
    AirplaneTracker3D/ContentView.swift
    AirplaneTracker3D/Rendering/MetalView.swift
    AirplaneTracker3D/Camera/OrbitCamera.swift
  </files>
  <action>
**ContentView.swift** -- Add airport search panel overlay:
- Add `@State private var showSearchPanel: Bool = false` state
- Add `@State private var cameraTarget: SIMD3<Float> = .zero` for passing to search VM
- In the ZStack, add a conditional overlay for AirportSearchPanel in the top-left area (below the theme button). Wrap in `if showSearchPanel { ... }` with `.transition(.move(edge: .leading))` animation.
- Listen for `.toggleSearch` notification via `.onReceive(NotificationCenter.default.publisher(for: .toggleSearch))` to toggle showSearchPanel with animation.
- Add `.toggleSearch` to the Notification.Name extension in ContentView.
- The search panel needs to know the camera target for nearby airports. Listen for a `.cameraTargetUpdated` notification (posted by Coordinator) to update cameraTarget, and pass it to the search panel view via an environment object or binding. Alternatively, make AirportSearchPanel accept a `cameraTarget: SIMD3<Float>` binding or value.
- Add a search button next to the theme button (magnifying glass icon) that posts `.toggleSearch`.

**MetalView.swift** -- Wire FlyToAnimator into the Coordinator:
- Add `let flyToAnimator = FlyToAnimator()` property to Coordinator
- In Coordinator.init(), add observer for `.flyToAirport` notification. Handler extracts the world position from notification.userInfo (key "position" as [NSNumber] array or similar), then calls `flyToAnimator.startFlyTo(from: renderer.camera, to: position)`. Also clear follow mode: `renderer.selectionManager.isFollowing = false; renderer.camera.followTarget = nil`.
- In `draw(in:)` (which calls `renderer?.draw(in: view)`), integrate the fly-to update. The cleanest approach: add the flyToAnimator call inside the Coordinator's draw forwarding. Before calling `renderer?.draw(in: view)`, call `flyToAnimator.update(camera: renderer.camera, deltaTime: deltaTime)`. BUT the Coordinator doesn't compute deltaTime -- the Renderer does internally. Better approach: give the Renderer a reference to the FlyToAnimator and call `flyToAnimator.update(camera: camera, deltaTime: deltaTime)` inside `Renderer.draw(in:)` right after `camera.update(deltaTime:)`.
- So: add `var flyToAnimator: FlyToAnimator?` to Renderer. In makeNSView, set `renderer.flyToAnimator = context.coordinator.flyToAnimator`. In Renderer.draw(in:), after `camera.update(deltaTime: deltaTime)`, add `flyToAnimator?.update(camera: camera, deltaTime: deltaTime)`.
- Add keyboard shortcut: in MetalMTKView.keyDown, add case "f" to post `.toggleSearch` notification.
- Also periodically post camera target for nearby airports: in Renderer.draw(in:), every ~30 frames, post `.cameraTargetUpdated` with camera.target as userInfo. Use a frame counter to throttle.
- Add `.flyToAirport` and `.cameraTargetUpdated` to Notification.Name extensions.

**OrbitCamera.swift** -- No structural changes needed. The FlyToAnimator directly mutates camera.target and camera.distance, which is compatible with the existing design. When FlyToAnimator.isAnimating is true, user gestures will still work (they'll fight the animation slightly, which is acceptable -- or optionally, check flyToAnimator.isAnimating in gesture handlers to ignore input during fly-to).
  </action>
  <verify>
Build succeeds: `cd /Users/mit/Documents/GitHub/airplane-tracker-3d && xcodebuild build -scheme AirplaneTracker3D -destination 'platform=macOS' 2>&1 | tail -5`

Verify wiring by searching for key connections:
- `grep -n "flyToAnimator" AirplaneTracker3D/Rendering/MetalView.swift` shows FlyToAnimator instantiation and notification handler
- `grep -n "flyToAnimator" AirplaneTracker3D/Rendering/Renderer.swift` shows update call in draw loop
- `grep -n "showSearchPanel" AirplaneTracker3D/ContentView.swift` shows toggle state
- `grep -n "toggleSearch" AirplaneTracker3D/ContentView.swift` shows notification listener
  </verify>
  <done>
Search panel toggles on/off from ContentView with keyboard shortcut "F" and a button. FlyToAnimator is driven by the Renderer's frame loop. Selecting an airport from search or nearby list smoothly animates the camera to that airport's world position. Follow mode is cleared before fly-to begins. Camera target is broadcast for nearby airport distance computation.
  </done>
</task>

</tasks>

<verification>
1. Build the project: `xcodebuild build -scheme AirplaneTracker3D -destination 'platform=macOS'` -- must succeed with zero errors
2. Verify AirportSearchPanel renders: check that ContentView conditionally shows AirportSearchPanel when showSearchPanel is true
3. Verify FlyToAnimator integration: grep confirms flyToAnimator.update() is called in Renderer.draw(in:) after camera.update()
4. Verify notification chain: .flyToAirport posted by AirportSearchViewModel, observed by MetalView.Coordinator, triggers FlyToAnimator
5. Verify search filtering: AirportSearchViewModel.filteredAirports filters by lowercased name/iata/icao
6. Verify nearby sorting: AirportSearchViewModel.nearbyAirports sorts by Euclidean XZ distance from camera target
</verification>

<success_criteria>
- User can press F or click search button to toggle the airport search panel
- User can type a query and see airports filtered by name, IATA, or ICAO code (max 10 results)
- User can switch to "Nearby" tab and see airports sorted by distance from current camera view
- User can click any airport result to trigger a smooth 2-second camera fly-to animation
- Fly-to animation uses smoothstep ease-in-out and clears any active follow mode
- Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-controls-settings-airports/09-01-SUMMARY.md`
</output>
