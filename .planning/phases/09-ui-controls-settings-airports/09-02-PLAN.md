---
phase: 09-ui-controls-settings-airports
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - AirplaneTracker3D/AirplaneTracker3DApp.swift
  - AirplaneTracker3D/Views/SettingsView.swift
  - AirplaneTracker3D/Views/InfoPanel.swift
  - AirplaneTracker3D/Views/StatisticsPanel.swift
  - AirplaneTracker3D/ViewModels/StatisticsCollector.swift
  - AirplaneTracker3D/ContentView.swift
  - AirplaneTracker3D/Rendering/Renderer.swift
  - AirplaneTracker3D/Rendering/MetalView.swift
autonomous: true

must_haves:
  truths:
    - "User can open Settings via Cmd+, and configure theme, units, data source, trail length/width, and altitude exaggeration"
    - "Settings changes persist across app restarts via UserDefaults/@AppStorage"
    - "User sees an info panel with live aircraft count, last update time, and center coordinates"
    - "User sees statistics graphs showing aircraft count and message rate over time"
    - "User can use keyboard shortcuts (Cmd+R reset camera, Cmd+T cycle theme, Cmd+F search, Cmd+I info panel) from the menu bar"
    - "Changing trail length/width or altitude exaggeration in settings takes effect immediately in the 3D view"
  artifacts:
    - path: "AirplaneTracker3D/Views/SettingsView.swift"
      provides: "Tabbed SwiftUI Settings view with @AppStorage-bound controls"
      min_lines: 80
    - path: "AirplaneTracker3D/Views/InfoPanel.swift"
      provides: "Compact overlay showing aircraft count, last update, center coords"
      min_lines: 30
    - path: "AirplaneTracker3D/Views/StatisticsPanel.swift"
      provides: "Swift Charts line graphs for aircraft count and message rate"
      min_lines: 60
    - path: "AirplaneTracker3D/ViewModels/StatisticsCollector.swift"
      provides: "Timer-based time-series data collector sampling every 5 seconds"
      min_lines: 40
    - path: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      provides: "Settings scene and CommandMenu with keyboard shortcuts"
      min_lines: 40
  key_links:
    - from: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      to: "AirplaneTracker3D/Views/SettingsView.swift"
      via: "Settings { SettingsView() } scene"
      pattern: "Settings.*SettingsView"
    - from: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      to: "NotificationCenter"
      via: "CommandMenu buttons post notification names for actions"
      pattern: "CommandMenu.*Tracker"
    - from: "AirplaneTracker3D/Views/SettingsView.swift"
      to: "UserDefaults"
      via: "@AppStorage writes settings keys read by Renderer at frame time"
      pattern: "@AppStorage"
    - from: "AirplaneTracker3D/Rendering/Renderer.swift"
      to: "UserDefaults"
      via: "UserDefaults.standard reads trailLength, trailWidth, altitudeExaggeration at frame time"
      pattern: "UserDefaults\\.standard\\.(integer|double)"
    - from: "AirplaneTracker3D/Views/StatisticsPanel.swift"
      to: "AirplaneTracker3D/ViewModels/StatisticsCollector.swift"
      via: "@ObservedObject collector provides data points for Charts"
      pattern: "StatisticsCollector"
---

<objective>
SwiftUI settings window, info panel, statistics graphs, keyboard shortcuts with menu bar, and settings persistence.

Purpose: Makes the app fully configurable and informative -- users control rendering parameters through a native Settings window, monitor flight stats through charts, see live info at a glance, and navigate efficiently via keyboard shortcuts reflected in the macOS menu bar. All preferences persist across restarts.

Output: SettingsView.swift, InfoPanel.swift, StatisticsPanel.swift, StatisticsCollector.swift, plus App-level Settings scene, CommandMenu, and Renderer-side UserDefaults reading.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-controls-settings-airports/09-RESEARCH.md
@.planning/phases/09-ui-controls-settings-airports/09-01-SUMMARY.md
@AirplaneTracker3D/AirplaneTracker3DApp.swift
@AirplaneTracker3D/ContentView.swift
@AirplaneTracker3D/Rendering/Renderer.swift
@AirplaneTracker3D/Rendering/ThemeManager.swift
@AirplaneTracker3D/Rendering/TrailManager.swift
@AirplaneTracker3D/Rendering/MetalView.swift
@AirplaneTracker3D/DataLayer/FlightDataActor.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: SettingsView, InfoPanel, StatisticsCollector, StatisticsPanel</name>
  <files>
    AirplaneTracker3D/Views/SettingsView.swift
    AirplaneTracker3D/Views/InfoPanel.swift
    AirplaneTracker3D/ViewModels/StatisticsCollector.swift
    AirplaneTracker3D/Views/StatisticsPanel.swift
  </files>
  <action>
Create four new files:

**SettingsView.swift** (in Views/):
- `struct SettingsView: View` with TabView for organized sections
- Use `@AppStorage` for all settings, with these keys and defaults:
  - `@AppStorage("selectedTheme") var selectedTheme = "day"` -- Picker with "day", "night", "retro" tags. When changed, post `.cycleThemeTo` notification with the new theme string (or simpler: just let the Renderer read UserDefaults at frame time and ThemeManager already persists via UserDefaults -- so just rely on @AppStorage writing the same "selectedTheme" key that ThemeManager reads). Actually, ThemeManager.current didSet writes to UserDefaults, and ThemeManager.init reads from UserDefaults. So @AppStorage("selectedTheme") in SettingsView writes the same key. But ThemeManager won't know it changed until next init or explicit read. Solution: when the Picker changes, post a notification that tells MetalView.Coordinator to set `renderer.themeManager.current` to the new theme. Use `.onChange(of: selectedTheme)` to post `.setTheme` notification with the theme string.
  - `@AppStorage("unitSystem") var unitSystem = "imperial"` -- Picker: "Imperial (ft, kts)" tag "imperial", "Metric (m, km/h)" tag "metric"
  - `@AppStorage("dataSource") var dataSource = "global"` -- Picker: "Global (airplanes.live)" tag "global", "Local (dump1090)" tag "local"
  - `@AppStorage("trailLength") var trailLength = 500.0` -- Slider 50...4000, step 50. Display current value.
  - `@AppStorage("trailWidth") var trailWidth = 3.0` -- Slider 1...10, step 0.5
  - `@AppStorage("altitudeExaggeration") var altitudeExaggeration = 1.0` -- Slider 0.5...5.0, step 0.5. Label shows "1.0x" format.
- Use TabView with `.tabItem` for two tabs: "Appearance" (theme, units) and "Rendering" (trail length, trail width, altitude exaggeration, data source)
- Style with `.frame(width: 400, height: 300)` for a reasonable settings window size
- On theme Picker change, use `.onChange(of: selectedTheme)` to post `.setTheme` notification with userInfo `["theme": selectedTheme]`

**InfoPanel.swift** (in Views/):
- `struct InfoPanel: View` accepting: `aircraftCount: Int`, `lastUpdateTime: Date`, `centerLat: Double`, `centerLon: Double`
- Compact VStack layout:
  - HStack with airplane SF Symbol + aircraft count in bold monospaced
  - "Updated:" + lastUpdateTime formatted as HH:mm:ss
  - Center coordinates formatted as "47.60, -122.30"
- Style: `.padding(8)`, `.background(.ultraThinMaterial)`, `.cornerRadius(8)` -- light/translucent, positioned bottom-left
- Keep it small and unobtrusive

**StatisticsCollector.swift** (in ViewModels/):
- `@MainActor final class StatisticsCollector: ObservableObject`
- Inner struct `DataPoint: Identifiable` with `id = UUID()`, `timestamp: Date`, `aircraftCount: Int`, `messageRate: Double`
- `@Published var dataPoints: [DataPoint] = []`
- `private var timer: Timer?`
- `private let maxPoints = 120` (10 minutes at 5-second intervals)
- `var aircraftCountProvider: (() -> Int)? = nil` -- closure set externally to get current aircraft count
- `var pollCount: Int = 0` -- incremented externally to derive message rate (polls per period)
- `func start()` -- creates Timer.scheduledTimer(withTimeInterval: 5.0, repeats: true) that reads aircraftCountProvider?() ?? 0, appends DataPoint, trims to maxPoints. For messageRate, use a simple `pollCount / elapsed_seconds` heuristic or just track aircraft count only (message rate is secondary -- if hard to wire, skip and just show aircraft count chart).
- `func stop()` -- invalidate timer
- Note: Timer closure must dispatch to MainActor. Use `Task { @MainActor in ... }` inside the timer closure, or since the class is @MainActor, schedule the timer on the main run loop (which Timer.scheduledTimer does by default).

**StatisticsPanel.swift** (in Views/):
- `import Charts`
- `struct StatisticsPanel: View` with `@ObservedObject var collector: StatisticsCollector`
- VStack with:
  - Title "Statistics" in caption bold
  - "Aircraft Count" chart using `Chart { ForEach(collector.dataPoints) { point in LineMark(x: .value("Time", point.timestamp), y: .value("Count", point.aircraftCount)).foregroundStyle(.blue) } }` with `.chartXAxis { AxisMarks(values: .stride(by: .minute)) { _ in AxisGridLine(); AxisValueLabel(format: .dateTime.hour().minute()) } }`
  - `.frame(height: 120)`
  - If dataPoints is empty, show "Collecting data..." placeholder text
- Style: dark background matching detail panel (Color.black.opacity(0.85)), rounded corners, .frame(width: 260)
- Close button at top-right posting `.toggleStats` notification
  </action>
  <verify>
Build succeeds: `cd /Users/mit/Documents/GitHub/airplane-tracker-3d && xcodebuild build -scheme AirplaneTracker3D -destination 'platform=macOS' 2>&1 | tail -5`

Verify files exist and have content:
- `wc -l AirplaneTracker3D/Views/SettingsView.swift` shows 80+ lines
- `wc -l AirplaneTracker3D/Views/InfoPanel.swift` shows 30+ lines
- `wc -l AirplaneTracker3D/ViewModels/StatisticsCollector.swift` shows 40+ lines
- `wc -l AirplaneTracker3D/Views/StatisticsPanel.swift` shows 60+ lines
- `grep -c "@AppStorage" AirplaneTracker3D/Views/SettingsView.swift` shows 6 @AppStorage bindings
  </verify>
  <done>
SettingsView provides tabbed preferences with @AppStorage persistence for theme, units, data source, trail length/width, and altitude exaggeration. InfoPanel shows live aircraft count, update time, and center coordinates. StatisticsCollector samples aircraft count every 5 seconds into a time-series. StatisticsPanel renders a Swift Charts line graph of collected data.
  </done>
</task>

<task type="auto">
  <name>Task 2: App-level Settings scene, CommandMenu, ContentView wiring, and Renderer UserDefaults reading</name>
  <files>
    AirplaneTracker3D/AirplaneTracker3DApp.swift
    AirplaneTracker3D/ContentView.swift
    AirplaneTracker3D/Rendering/Renderer.swift
    AirplaneTracker3D/Rendering/MetalView.swift
  </files>
  <action>
**AirplaneTracker3DApp.swift** -- Add Settings scene and CommandMenu:
- Add `Settings { SettingsView() }` as a second scene after WindowGroup. This gives the standard Cmd+, shortcut automatically.
- Add `.commands { AppCommands() }` modifier on WindowGroup
- Create `struct AppCommands: Commands` with body containing:
  - `CommandMenu("Tracker")` with:
    - "Reset Camera" button posting `.resetCamera` notification, `.keyboardShortcut("r", modifiers: .command)`
    - "Toggle Auto-Rotate" posting `.toggleAutoRotate`, `.keyboardShortcut("a", modifiers: [.command, .shift])` (Cmd+Shift+A to avoid conflict with Select All)
    - Divider
    - "Cycle Theme" posting `.cycleTheme`, `.keyboardShortcut("t", modifiers: .command)`
    - Divider
    - "Search Airport" posting `.toggleSearch`, `.keyboardShortcut("f", modifiers: .command)`
    - "Toggle Info Panel" posting `.toggleInfoPanel`, `.keyboardShortcut("i", modifiers: .command)`
    - "Toggle Statistics" posting `.toggleStats`, `.keyboardShortcut("s", modifiers: [.command, .shift])` (Cmd+Shift+S to avoid conflict with Save)
- Add new Notification.Name extensions: `.resetCamera`, `.toggleAutoRotate`, `.toggleInfoPanel`, `.toggleStats`, `.setTheme`

**ContentView.swift** -- Wire info panel, stats panel, and collectors:
- Add `@State private var showInfoPanel: Bool = true` (visible by default)
- Add `@State private var showStatsPanel: Bool = false`
- Add `@StateObject private var statisticsCollector = StatisticsCollector()`
- Add `@State private var aircraftCount: Int = 0`
- Add `@State private var lastUpdateTime: Date = Date()`
- Add `@State private var centerLat: Double = 47.6` and `centerLon: Double = -122.3`
- In ZStack, add InfoPanel overlay at bottom-left (inside a VStack with Spacer at top, HStack with panel then Spacer):
  ```
  if showInfoPanel {
      InfoPanel(aircraftCount: aircraftCount, lastUpdateTime: lastUpdateTime,
                centerLat: centerLat, centerLon: centerLon)
      .transition(.opacity)
  }
  ```
- Add StatisticsPanel overlay at bottom-right (conditionally shown):
  ```
  if showStatsPanel {
      StatisticsPanel(collector: statisticsCollector)
      .transition(.move(edge: .bottom))
  }
  ```
- Listen for `.toggleInfoPanel` and `.toggleStats` notifications to toggle respective states with animation
- Listen for `.aircraftCountUpdated` notification (posted by Renderer, see below) to update aircraftCount and lastUpdateTime
- Listen for `.cameraTargetUpdated` notification to update centerLat/centerLon (convert camera target back to lat/lon via MapCoordinateSystem.shared.zToLat/xToLon)
- On `.onAppear`, configure statisticsCollector.aircraftCountProvider to return aircraftCount, and call statisticsCollector.start()
- On `.onDisappear`, call statisticsCollector.stop()
- Add `.allowsHitTesting(false)` on the outer overlay container VStack/ZStack for info panel (it's display-only, should not block Metal clicks). Only interactive panels (search, stats close button) need hit testing.

**Renderer.swift** -- Read UserDefaults at frame time for settings:
- At the top of `draw(in:)`, after the timing section, read settings from UserDefaults:
  ```swift
  // Read configurable settings from UserDefaults (written by SettingsView @AppStorage)
  let settingsTrailLength = UserDefaults.standard.integer(forKey: "trailLength")
  if settingsTrailLength > 0 {
      trailManager.maxTrailLength = settingsTrailLength
  }
  let settingsTrailWidth = UserDefaults.standard.double(forKey: "trailWidth")
  if settingsTrailWidth > 0 {
      trailManager.lineWidth = Float(settingsTrailWidth)
  }
  let settingsAltExag = UserDefaults.standard.double(forKey: "altitudeExaggeration")
  // altitudeExaggeration multiplies the base altitude scale (0.001)
  // Store as a property or apply inline when computing altWorld in FlightDataManager
  ```
  For altitude exaggeration: the cleanest approach is to add an `altitudeExaggeration: Float` property to Renderer, read it from UserDefaults each frame, and use it as a multiplier. However, altitude is computed in FlightDataManager.interpolatedStates(). Since that's @MainActor and called from draw(), the simplest approach is to read the UserDefaults value and multiply each state's position.y. BUT modifying states in Renderer is messy. Better: add a public `altitudeExaggeration: Float = 1.0` property to FlightDataManager, and in interpolatedStates(), multiply `altWorld` by `altitudeExaggeration`. Then in Renderer.draw(), before calling interpolatedStates, update `flightDataManager?.altitudeExaggeration = Float(settingsAltExag > 0 ? settingsAltExag : 1.0)`.

  Wait -- FlightDataManager is @MainActor and draw() runs on main thread, so this is safe.

  Actually, the simpler approach (avoiding FlightDataManager changes): read altitudeExaggeration in Renderer and scale the Y component of each state's position after interpolatedStates() returns. Add right after `let states = ...`:
  ```swift
  let altExag = Float(UserDefaults.standard.double(forKey: "altitudeExaggeration"))
  let adjustedStates: [InterpolatedAircraftState]
  if altExag > 0 && altExag != 1.0 {
      adjustedStates = states.map { var s = $0; s.position.y *= altExag; return s }
  } else {
      adjustedStates = states
  }
  ```
  Then use `adjustedStates` instead of `states` for all downstream rendering calls. This is clean and contained within Renderer.

- Post aircraft count periodically: every 60 frames (~1 second), post `.aircraftCountUpdated` notification with userInfo containing "count" and "time":
  ```swift
  if frameCounter % 60 == 0 {
      NotificationCenter.default.post(name: .aircraftCountUpdated, object: nil,
          userInfo: ["count": states.count, "time": Date()])
  }
  ```
  Add a `private var frameCounter: Int = 0` property, increment each frame.

**MetalView.swift** -- Handle new notifications in Coordinator:
- Add observer for `.resetCamera` -- calls `renderer?.camera.reset()`
- Add observer for `.toggleAutoRotate` -- toggles `renderer?.camera.isAutoRotating`
- Add observer for `.setTheme` -- extracts theme string from userInfo, converts to Theme enum, sets `renderer?.themeManager.current`
- These extend the existing notification observer pattern in Coordinator.init()
- Add `.aircraftCountUpdated` and other new notification names to the extension
  </action>
  <verify>
Build succeeds: `cd /Users/mit/Documents/GitHub/airplane-tracker-3d && xcodebuild build -scheme AirplaneTracker3D -destination 'platform=macOS' 2>&1 | tail -5`

Verify integrations:
- `grep -n "Settings {" AirplaneTracker3D/AirplaneTracker3DApp.swift` shows Settings scene
- `grep -n "CommandMenu" AirplaneTracker3D/AirplaneTracker3DApp.swift` shows menu bar
- `grep -n "UserDefaults.standard" AirplaneTracker3D/Rendering/Renderer.swift` shows settings reading
- `grep -n "InfoPanel" AirplaneTracker3D/ContentView.swift` shows info panel overlay
- `grep -n "StatisticsPanel" AirplaneTracker3D/ContentView.swift` shows stats panel overlay
- `grep -n "@AppStorage" AirplaneTracker3D/Views/SettingsView.swift` shows persistence bindings
- `grep -n "keyboardShortcut" AirplaneTracker3D/AirplaneTracker3DApp.swift` shows shortcuts defined
  </verify>
  <done>
Cmd+, opens a native Settings window with tabbed controls for theme, units, data source, trail length/width, and altitude exaggeration -- all persisted via @AppStorage/UserDefaults. A "Tracker" menu in the menu bar provides keyboard shortcuts for camera reset, auto-rotate, theme cycling, search, info panel, and statistics. InfoPanel shows live aircraft count, update time, and center coordinates as a bottom-left overlay. StatisticsPanel shows a Swift Charts line graph of aircraft count over time. Renderer reads trail and altitude settings from UserDefaults at frame time for immediate visual feedback.
  </done>
</task>

</tasks>

<verification>
1. Build the project: `xcodebuild build -scheme AirplaneTracker3D -destination 'platform=macOS'` -- must succeed with zero errors
2. Verify Settings scene: AirplaneTracker3DApp.swift contains `Settings { SettingsView() }`
3. Verify CommandMenu: AirplaneTracker3DApp.swift contains `CommandMenu("Tracker")` with keyboardShortcut modifiers
4. Verify @AppStorage keys: SettingsView uses @AppStorage for selectedTheme, unitSystem, dataSource, trailLength, trailWidth, altitudeExaggeration
5. Verify Renderer reads settings: Renderer.draw(in:) reads UserDefaults.standard for trailLength, trailWidth, altitudeExaggeration
6. Verify InfoPanel wiring: ContentView shows InfoPanel with aircraftCount from notification
7. Verify StatisticsCollector: Timer-based sampling with maxPoints cap at 120
8. Verify Charts import: StatisticsPanel imports Charts and uses LineMark
</verification>

<success_criteria>
- Cmd+, opens a Settings window with theme picker, unit picker, data source picker, and sliders for trail length/width/altitude exaggeration
- Closing and reopening the app preserves all settings values
- Changing trail length or width in Settings immediately affects trail rendering in the 3D view
- Changing altitude exaggeration in Settings immediately scales aircraft altitude in the 3D view
- Info panel shows aircraft count, last update time, and center coordinates (toggleable via Cmd+I)
- Statistics panel shows a time-series line chart of aircraft count (toggleable via Cmd+Shift+S)
- Menu bar shows "Tracker" menu with all shortcuts: Cmd+R, Cmd+T, Cmd+F, Cmd+I, Cmd+Shift+A, Cmd+Shift+S
- Keyboard shortcuts trigger the correct actions
- Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-controls-settings-airports/09-02-SUMMARY.md`
</output>
