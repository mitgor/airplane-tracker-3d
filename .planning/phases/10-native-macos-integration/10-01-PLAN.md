---
phase: 10-native-macos-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AirplaneTracker3D/AirplaneTracker3DApp.swift
  - AirplaneTracker3D/Services/MenuBarManager.swift
  - AirplaneTracker3D/Services/DockBadgeManager.swift
  - AirplaneTracker3D/Services/NotificationManager.swift
  - AirplaneTracker3D/Models/AlertCondition.swift
  - AirplaneTracker3D/Views/SettingsView.swift
  - AirplaneTracker3D/Rendering/Renderer.swift
autonomous: true

must_haves:
  truths:
    - "User sees live aircraft count in the macOS menu bar status item (airplane icon + number)"
    - "User sees aircraft count badge on the dock icon (red badge, clears when count is 0)"
    - "User receives macOS notification banners for emergency squawk codes (7500, 7600, 7700) even when the app is in the foreground"
    - "User can configure notification alerts (enable/disable, emergency squawks) in the Settings window"
    - "Notifications do not spam -- same alert fires at most once per 5 minutes per aircraft per condition"
  artifacts:
    - path: "AirplaneTracker3D/Services/MenuBarManager.swift"
      provides: "Shared observable managing aircraft count state for menu bar and dock badge"
    - path: "AirplaneTracker3D/Services/NotificationManager.swift"
      provides: "UNUserNotificationCenter wrapper with permission request, alert evaluation, cooldown deduplication, and foreground delivery delegate"
    - path: "AirplaneTracker3D/Models/AlertCondition.swift"
      provides: "AlertCondition Codable model with emergency squawk and callsign alert types"
    - path: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      provides: "MenuBarExtra scene showing airplane icon + live count"
  key_links:
    - from: "AirplaneTracker3D/Rendering/Renderer.swift"
      to: "AirplaneTracker3D/Services/MenuBarManager.swift"
      via: "NotificationCenter .aircraftCountUpdated posting count+states"
      pattern: "aircraftCountUpdated.*userInfo"
    - from: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      to: "AirplaneTracker3D/Services/MenuBarManager.swift"
      via: "@StateObject MenuBarManager driving MenuBarExtra label and dock badge"
      pattern: "MenuBarExtra.*aircraftCount"
    - from: "AirplaneTracker3D/Services/MenuBarManager.swift"
      to: "AirplaneTracker3D/Services/NotificationManager.swift"
      via: "MenuBarManager passes InterpolatedAircraftState array to NotificationManager.evaluateAlerts()"
      pattern: "evaluateAlerts"
---

<objective>
Add a macOS menu bar status item showing live aircraft count, a dock icon badge, and a configurable notification system for aircraft alerts (emergency squawks, specific callsigns).

Purpose: Makes the app feel like a first-class macOS citizen -- users see aircraft activity at a glance without switching to the app, and get alerted to interesting events like emergency squawk codes.

Output: MenuBarExtra scene, DockBadgeManager, NotificationManager with UNUserNotificationCenter, AlertCondition model, Notifications settings tab.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@AirplaneTracker3D/AirplaneTracker3DApp.swift
@AirplaneTracker3D/ContentView.swift
@AirplaneTracker3D/Views/SettingsView.swift
@AirplaneTracker3D/Models/AircraftModel.swift
@AirplaneTracker3D/Rendering/Renderer.swift
@.planning/phases/10-native-macos-integration/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Menu bar status item, dock badge, and aircraft state broadcast</name>
  <files>
    AirplaneTracker3D/Services/MenuBarManager.swift
    AirplaneTracker3D/Services/DockBadgeManager.swift
    AirplaneTracker3D/AirplaneTracker3DApp.swift
    AirplaneTracker3D/Rendering/Renderer.swift
  </files>
  <action>
Create two new files in a new `Services/` directory and modify two existing files:

**1. `Services/MenuBarManager.swift`** -- `@MainActor final class MenuBarManager: ObservableObject`:
- `@Published var aircraftCount: Int = 0`
- Subscribe to `.aircraftCountUpdated` NotificationCenter in init. When notification arrives, extract `count` from userInfo as Int, update `aircraftCount`. Also call `DockBadgeManager.shared.updateBadge(count:)`.
- Also receive the `"states"` key from the same notification (see Renderer change below) and forward to `NotificationManager.shared.evaluateAlerts(for:)`.
- Use `.onReceive` is NOT needed here -- use `NotificationCenter.default.addObserver(forName:object:queue:)` with `.main` queue since this is an ObservableObject, not a View.
- Store the observer token and remove it in deinit.

**2. `Services/DockBadgeManager.swift`** -- `@MainActor final class DockBadgeManager`:
- `static let shared = DockBadgeManager()`
- `func updateBadge(count: Int)` -- sets `NSApplication.shared.dockTile.badgeLabel = count > 0 ? "\(count)" : nil`
- `func clearBadge()` -- sets badgeLabel to nil

**3. Modify `AirplaneTracker3DApp.swift`:**
- Add `@StateObject private var menuBarManager = MenuBarManager()` to the App struct.
- Add a `MenuBarExtra` scene AFTER the existing `Settings` scene:
```swift
MenuBarExtra {
    VStack(alignment: .leading, spacing: 4) {
        Text("Aircraft Tracked: \(menuBarManager.aircraftCount)")
            .font(.headline)
        Divider()
        Button("Show Window") {
            NSApplication.shared.activate(ignoringOtherApps: true)
        }
        Button("Quit") {
            NSApplication.shared.terminate(nil)
        }
        .keyboardShortcut("q")
    }
    .padding(8)
} label: {
    Label("\(menuBarManager.aircraftCount)", systemImage: "airplane")
}
.menuBarExtraStyle(.menu)
```
- The Label with both text and systemImage shows the airplane icon + count in the menu bar.

**4. Modify `Renderer.swift`** in the existing `aircraftCountUpdated` notification post (around line 968):
- In addition to "count" and "time", add the `states` array to userInfo. The states are already computed at this point (the `states` local variable). Since `InterpolatedAircraftState` is `Sendable` but not an Obj-C type, wrap it: post `"states": states` in the userInfo dictionary. Swift allows this because userInfo is `[AnyHashable: Any]`.
- Change the existing post to:
```swift
NotificationCenter.default.post(
    name: .aircraftCountUpdated,
    object: nil,
    userInfo: ["count": states.count, "time": Date(), "states": states]
)
```
- This piggybacks alert evaluation on the existing 60-frame broadcast without adding any new timer or polling.

Add both new files to the Xcode project's `pbxproj` (use the existing group structure pattern from the project file, or if that's too complex, just create the files and note that Xcode auto-discovers files in the project directory with the "folder reference" model). Check if the project uses folder references -- if so, new files are auto-discovered. If it uses explicit file references, add them to the pbxproj.
  </action>
  <verify>
Build with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5` -- should compile without errors. Verify MenuBarManager.swift and DockBadgeManager.swift exist in Services/. Verify AirplaneTracker3DApp.swift contains `MenuBarExtra`.
  </verify>
  <done>
Menu bar shows airplane icon with aircraft count that updates every ~1 second. Dock icon shows red badge with aircraft count (or no badge when count is 0). MenuBarExtra dropdown shows count, "Show Window" button, and "Quit" button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Notification system with alert conditions and Settings tab</name>
  <files>
    AirplaneTracker3D/Services/NotificationManager.swift
    AirplaneTracker3D/Models/AlertCondition.swift
    AirplaneTracker3D/Views/SettingsView.swift
  </files>
  <action>
Create two new files and modify SettingsView:

**1. `Models/AlertCondition.swift`:**
```swift
import Foundation

struct AlertCondition: Codable, Identifiable {
    let id: UUID
    var type: AlertType
    var isEnabled: Bool

    enum AlertType: Codable {
        case callsign(String)
        case emergencySquawk  // covers 7500, 7600, 7700
    }

    init(type: AlertType, isEnabled: Bool = true) {
        self.id = UUID()
        self.type = type
        self.isEnabled = isEnabled
    }
}
```

**2. `Services/NotificationManager.swift`** -- `@MainActor final class NotificationManager: NSObject, ObservableObject, UNUserNotificationCenterDelegate`:
- `import UserNotifications` at top.
- `static let shared = NotificationManager()`
- `@Published var isAuthorized = false`
- `@AppStorage("notificationsEnabled") var notificationsEnabled = false`
- `@AppStorage("alertOnEmergencySquawk") var alertOnEmergencySquawk = true`
- `@AppStorage("watchedCallsigns") private var watchedCallsignsRaw: String = ""` -- comma-separated string, parsed into Set<String>.
- Computed property `var watchedCallsigns: Set<String>` that splits on comma and trims whitespace.
- `private var firedAlerts: [String: Date] = [:]` -- deduplication map. Key = "hex-conditionType".
- `private let cooldownInterval: TimeInterval = 300` -- 5 minutes.
- In `override init()`: call `super.init()`, then set `UNUserNotificationCenter.current().delegate = self`.
- `func requestPermission() async` -- calls `UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge])`, stores result in `isAuthorized`.
- `func evaluateAlerts(for states: [InterpolatedAircraftState])`:
  - Guard `notificationsEnabled && isAuthorized` else return.
  - Clean expired cooldowns from `firedAlerts` (remove entries older than `cooldownInterval`).
  - For each aircraft in states:
    - If `alertOnEmergencySquawk` and squawk is "7500", "7600", or "7700": build key `"\(aircraft.hex)-squawk-\(aircraft.squawk)"`. If key NOT in firedAlerts, add it with current Date and send notification with title "Squawk {code} - {meaning}" and body "{callsign or hex} at {altitude} ft".
    - If `watchedCallsigns` is not empty and aircraft.callsign (trimmed, uppercased) is in watchedCallsigns: build key `"\(aircraft.hex)-callsign"`. If not in firedAlerts, add and notify with title "Watched Aircraft" and body "{callsign} spotted at {altitude} ft".
  - Squawk meanings: 7700="EMERGENCY", 7600="RADIO FAILURE", 7500="HIJACK".
- `private func sendNotification(title: String, body: String, identifier: String)`: create `UNMutableNotificationContent`, set title/body/sound(.default), create `UNTimeIntervalNotificationTrigger(timeInterval: 0.1, repeats: false)`, add request to `UNUserNotificationCenter.current()`.
- Implement `nonisolated func userNotificationCenter(_:willPresent:withCompletionHandler:)` -- call `completionHandler([.banner, .sound])` so notifications show even when app is foreground.

**3. Modify `Views/SettingsView.swift`:**
- Add a third "Notifications" tab with `Label("Notifications", systemImage: "bell")`.
- `@StateObject private var notificationManager = NotificationManager.shared` (or use `@ObservedObject`).
- Add `@AppStorage("notificationsEnabled")` toggle.
- Add `@AppStorage("alertOnEmergencySquawk")` toggle (disabled when notifications not enabled).
- Add a TextField for watched callsigns (comma-separated) bound to `@AppStorage("watchedCallsigns")`.
- Add a "Request Permission" button that calls `Task { await notificationManager.requestPermission() }`. Show authorization status text.
- Increase frame height from 300 to 350 to accommodate the new tab.
- The tab content should be wrapped in a Form like existing tabs.

Also update `MenuBarManager` (from Task 1) to call `NotificationManager.shared.evaluateAlerts(for:)` when it receives states. If Task 1 already wired this, verify it works. The states extraction from the notification userInfo should be: `if let states = notification.userInfo?["states"] as? [InterpolatedAircraftState]`.
  </action>
  <verify>
Build with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5` -- should compile without errors. Verify NotificationManager.swift exists. Verify SettingsView.swift has 3 tabs. Grep for "UNUserNotificationCenter" in NotificationManager.swift. Grep for "evaluateAlerts" in MenuBarManager.swift.
  </verify>
  <done>
NotificationManager requests permission, evaluates emergency squawks and watched callsigns against live aircraft data, sends macOS notifications with 5-minute per-aircraft cooldown, shows banners in foreground. Settings window has a Notifications tab with enable toggle, emergency squawk toggle, watched callsigns field, and permission request button.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds with zero errors
2. Menu bar shows airplane icon with updating count
3. Dock icon shows red badge with count
4. Settings > Notifications tab exists with toggles and permission button
5. Grep confirms: `MenuBarExtra` in App file, `UNUserNotificationCenter` in NotificationManager, `evaluateAlerts` wired from MenuBarManager
</verification>

<success_criteria>
- Menu bar status item displays airplane icon + live aircraft count
- Dock icon badge shows aircraft count, clears when 0
- Notifications fire for emergency squawk codes (7500/7600/7700) with 5-minute cooldown
- Notifications fire for watched callsigns
- Settings window has Notifications tab with enable/disable and permission controls
- Notifications appear as macOS banners even when app is in foreground
</success_criteria>

<output>
After completion, create `.planning/phases/10-native-macos-integration/10-01-SUMMARY.md`
</output>
