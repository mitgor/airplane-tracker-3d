---
phase: 10-native-macos-integration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - AirplaneTracker3D/AirplaneTracker3DApp.swift
  - AirplaneTracker3D/AirplaneTracker3D.entitlements
  - ExportOptions.plist
  - Scripts/build-dmg.sh
autonomous: true

must_haves:
  truths:
    - "User sees standard File, Edit, View, and Window menus in the macOS menu bar with appropriate items"
    - "User can use Cmd+W to close the window, Cmd+Q to quit, Cmd+, to open settings"
    - "User can use View menu items to toggle info panel (Cmd+I) and statistics (Cmd+Shift+S)"
    - "The existing Tracker menu with its 6 shortcuts continues to work unchanged"
    - "A build-dmg.sh script exists that builds a release archive, creates a DMG with Applications drop link, and documents both signed and unsigned distribution paths"
    - "An entitlements file exists with com.apple.security.network.client for hardened runtime network access"
  artifacts:
    - path: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      provides: "Enhanced AppCommands with CommandGroup placements for standard menus alongside existing Tracker menu"
      contains: "CommandGroup"
    - path: "AirplaneTracker3D/AirplaneTracker3D.entitlements"
      provides: "Entitlements plist with network.client for hardened runtime code signing"
      contains: "com.apple.security.network.client"
    - path: "Scripts/build-dmg.sh"
      provides: "Complete build + sign + notarize + DMG script with signed and unsigned paths"
      contains: "xcodebuild archive"
    - path: "ExportOptions.plist"
      provides: "Xcode export options for Developer ID distribution"
      contains: "developer-id"
  key_links:
    - from: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      to: "Standard macOS menus"
      via: "CommandGroup(replacing:) and CommandGroup(after:) placements in AppCommands"
      pattern: "CommandGroup"
    - from: "Scripts/build-dmg.sh"
      to: "AirplaneTracker3D/AirplaneTracker3D.entitlements"
      via: "codesign references entitlements file during signing"
      pattern: "entitlements"
---

<objective>
Add standard macOS menus (File, Edit, View, Window) via CommandGroup placements to the existing AppCommands, create the entitlements file for hardened runtime, and build the complete DMG distribution infrastructure (build script, export options, documentation of signed vs unsigned paths).

Purpose: Completes the native macOS feel with standard menus users expect, and provides the infrastructure to ship the app as a downloadable DMG -- either signed/notarized (with Apple Developer Program) or unsigned (right-click to open).

Output: Enhanced AppCommands with standard menu items, entitlements plist, ExportOptions.plist, build-dmg.sh script.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@AirplaneTracker3D/AirplaneTracker3DApp.swift
@.planning/phases/10-native-macos-integration/10-01-SUMMARY.md
@.planning/phases/10-native-macos-integration/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standard macOS menus via CommandGroup placements</name>
  <files>
    AirplaneTracker3D/AirplaneTracker3DApp.swift
  </files>
  <action>
Modify the existing `AppCommands` struct in `AirplaneTracker3DApp.swift` to ADD standard macOS menu integrations via `CommandGroup` placements. The existing `CommandMenu("Tracker")` with its 6 buttons MUST remain unchanged.

Add the following CommandGroup placements BEFORE the existing CommandMenu("Tracker"):

**1. File menu -- remove "New Window" (single-window app):**
```swift
CommandGroup(replacing: .newItem) { }
```

**2. View menu -- add app-specific toggle items after the toolbar section:**
```swift
CommandGroup(after: .toolbar) {
    Button("Toggle Info Panel") {
        NotificationCenter.default.post(name: .toggleInfoPanel, object: nil)
    }
    .keyboardShortcut("i", modifiers: .command)

    Button("Toggle Statistics") {
        NotificationCenter.default.post(name: .toggleStats, object: nil)
    }
    .keyboardShortcut("s", modifiers: [.command, .shift])

    Divider()

    Button("Toggle Airport Search") {
        NotificationCenter.default.post(name: .toggleSearch, object: nil)
    }
    .keyboardShortcut("f", modifiers: .command)
}
```

**3. Window menu -- add "Reset Camera" as a window-level action:**
```swift
CommandGroup(after: .windowArrangement) {
    Divider()
    Button("Reset Camera to Default") {
        NotificationCenter.default.post(name: .resetCamera, object: nil)
    }
    .keyboardShortcut("0", modifiers: .command)
}
```

**IMPORTANT:** The existing `CommandMenu("Tracker")` block must remain as-is. The Tracker menu items (Reset Camera Cmd+R, Toggle Auto-Rotate Cmd+Shift+A, Cycle Theme Cmd+T, Search Airport Cmd+F, Toggle Info Panel Cmd+I, Toggle Statistics Cmd+Shift+S) stay in the Tracker menu. Some items intentionally appear in BOTH the Tracker menu and the View/Window menus -- this is standard macOS practice where the same action is accessible from multiple menu locations. However, to avoid duplicate shortcut conflicts, REMOVE the keyboard shortcuts from the View menu versions where they duplicate Tracker menu shortcuts:

Actually, to avoid keyboard shortcut conflicts (SwiftUI will warn about duplicate shortcuts), use a cleaner approach:
- Keep the Tracker menu shortcuts as-is (they are the primary shortcuts).
- In the View > CommandGroup(after: .toolbar), do NOT add .keyboardShortcut modifiers since those actions already have shortcuts in the Tracker menu.
- In the Window > CommandGroup, use a DIFFERENT shortcut (Cmd+0) for Reset Camera since Cmd+R is already used in the Tracker menu.

So the View menu items should be:
```swift
CommandGroup(after: .toolbar) {
    Button("Toggle Info Panel") {
        NotificationCenter.default.post(name: .toggleInfoPanel, object: nil)
    }

    Button("Toggle Statistics") {
        NotificationCenter.default.post(name: .toggleStats, object: nil)
    }

    Divider()

    Button("Toggle Airport Search") {
        NotificationCenter.default.post(name: .toggleSearch, object: nil)
    }
}
```
(No keyboard shortcuts on these -- the Tracker menu provides the shortcuts.)

The resulting menu bar should show: AirplaneTracker3D | File | Edit | View | Window | Tracker | Help
where File has no "New Window", View has the toggle items, Window has the camera reset, and Tracker has the existing 6 items with their shortcuts.

Note: SwiftUI automatically provides the Edit menu (with Undo, Redo, Cut, Copy, Paste, Select All), the Window menu (Minimize, Zoom, Bring All to Front), and the Help menu. The Cmd+Q (quit), Cmd+W (close window), and Cmd+, (settings) are provided automatically by the system + Settings scene. We do NOT need to add those manually.
  </action>
  <verify>
Build with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5` -- should compile without errors. Grep for "CommandGroup" in AirplaneTracker3DApp.swift. Grep for "CommandMenu" to confirm Tracker menu still exists. Verify no duplicate keyboard shortcut warnings in build output.
  </verify>
  <done>
Standard macOS menus (File, Edit, View, Window) appear in the menu bar. File has no "New Window" item. View menu has toggle items for info panel, statistics, and airport search. Window menu has "Reset Camera to Default". The existing Tracker menu with all 6 shortcuts remains unchanged. Cmd+W, Cmd+Q, Cmd+, all work via system defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Entitlements, export options, and DMG build script</name>
  <files>
    AirplaneTracker3D/AirplaneTracker3D.entitlements
    ExportOptions.plist
    Scripts/build-dmg.sh
  </files>
  <action>
Create three new files for code signing and distribution:

**1. `AirplaneTracker3D/AirplaneTracker3D.entitlements`:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <!-- Required: app fetches ADS-B flight data over the network -->
    <key>com.apple.security.network.client</key>
    <true/>
</dict>
</plist>
```
This entitlement is required for hardened runtime to allow outgoing network connections to airplanes.live, adsb.lol, hexdb.io, adsbdb.com, and tile servers.

**2. `ExportOptions.plist`** (at project root):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>developer-id</string>
    <key>signingStyle</key>
    <string>automatic</string>
</dict>
</plist>
```
Note: `teamID` is intentionally omitted -- the developer sets it via Xcode or xcodebuild argument. This avoids hardcoding a specific team.

**3. `Scripts/build-dmg.sh`** (create Scripts/ directory at project root):
```bash
#!/bin/bash
# Build, sign, notarize, and create DMG for AirplaneTracker3D
#
# Usage:
#   ./Scripts/build-dmg.sh                    # Unsigned build (no Developer ID needed)
#   ./Scripts/build-dmg.sh --signed           # Signed + notarized (requires Apple Developer Program)
#
# Prerequisites:
#   - Xcode with command line tools installed
#   - For --signed: Apple Developer Program membership, "Developer ID Application" certificate
#   - For --signed: Run once: xcrun notarytool store-credentials "notary-airplanetracker"
#   - Optional: brew install create-dmg (for polished DMG layout)

set -euo pipefail

APP_NAME="AirplaneTracker3D"
SCHEME="AirplaneTracker3D"
PROJECT="${APP_NAME}.xcodeproj"
BUILD_DIR="build"
ARCHIVE_PATH="${BUILD_DIR}/${APP_NAME}.xcarchive"
EXPORT_PATH="${BUILD_DIR}/export"
DMG_NAME="${APP_NAME}.dmg"
DMG_PATH="${BUILD_DIR}/${DMG_NAME}"
NOTARY_PROFILE="notary-airplanetracker"
SIGNED=false

# Parse arguments
for arg in "$@"; do
    case $arg in
        --signed) SIGNED=true ;;
        *) echo "Unknown argument: $arg"; exit 1 ;;
    esac
done

echo "=== AirplaneTracker3D Build Script ==="
echo "Mode: $(if $SIGNED; then echo 'Signed + Notarized'; else echo 'Unsigned'; fi)"
echo ""

# Clean build directory
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"

# Step 1: Archive
echo "--- Step 1: Archive ---"
xcodebuild archive \
    -project "$PROJECT" \
    -scheme "$SCHEME" \
    -configuration Release \
    -archivePath "$ARCHIVE_PATH" \
    -quiet

echo "Archive created at $ARCHIVE_PATH"

# Step 2: Export
echo "--- Step 2: Export ---"
if $SIGNED; then
    xcodebuild -exportArchive \
        -archivePath "$ARCHIVE_PATH" \
        -exportOptionsPlist ExportOptions.plist \
        -exportPath "$EXPORT_PATH" \
        -quiet
else
    # For unsigned: extract app directly from archive
    mkdir -p "$EXPORT_PATH"
    cp -R "${ARCHIVE_PATH}/Products/Applications/${APP_NAME}.app" "${EXPORT_PATH}/"

    # Ad-hoc sign with hardened runtime + entitlements (required for modern macOS)
    codesign --force --deep --sign - \
        --entitlements "${APP_NAME}/${APP_NAME}.entitlements" \
        --options runtime \
        "${EXPORT_PATH}/${APP_NAME}.app"
fi

echo "App exported to $EXPORT_PATH"

# Step 3: Create DMG
echo "--- Step 3: Create DMG ---"
if command -v create-dmg &>/dev/null; then
    # Polished DMG with create-dmg
    create-dmg \
        --volname "$APP_NAME" \
        --window-pos 200 120 \
        --window-size 600 400 \
        --icon "${APP_NAME}.app" 150 190 \
        --app-drop-link 450 190 \
        --icon-size 100 \
        --no-internet-enable \
        "$DMG_PATH" \
        "${EXPORT_PATH}/" || true
    # create-dmg returns non-zero if DMG already exists; || true handles that
else
    # Fallback: basic DMG with hdiutil
    echo "Note: Install create-dmg (brew install create-dmg) for a polished DMG layout."
    STAGING="${BUILD_DIR}/dmg-staging"
    mkdir -p "$STAGING"
    cp -R "${EXPORT_PATH}/${APP_NAME}.app" "$STAGING/"
    ln -s /Applications "$STAGING/Applications"

    hdiutil create -volname "$APP_NAME" \
        -srcfolder "$STAGING" \
        -ov -format UDZO \
        "$DMG_PATH"

    rm -rf "$STAGING"
fi

echo "DMG created at $DMG_PATH"

# Step 4: Notarize (signed only)
if $SIGNED; then
    echo "--- Step 4: Notarize ---"
    xcrun notarytool submit "$DMG_PATH" \
        --keychain-profile "$NOTARY_PROFILE" \
        --wait

    echo "--- Step 5: Staple ---"
    xcrun stapler staple "$DMG_PATH"
    xcrun stapler validate "$DMG_PATH"

    echo ""
    echo "=== SUCCESS: Signed + notarized DMG ready ==="
    echo "File: $DMG_PATH"
    echo "Users can install by double-clicking the DMG."
else
    echo ""
    echo "=== SUCCESS: Unsigned DMG ready ==="
    echo "File: $DMG_PATH"
    echo ""
    echo "DISTRIBUTION NOTE:"
    echo "  Since this DMG is not notarized, users must:"
    echo "  1. Right-click the app and select 'Open' on first launch"
    echo "  2. Or: System Settings > Privacy & Security > Open Anyway"
    echo ""
    echo "  To create a notarized DMG:"
    echo "  1. Join Apple Developer Program ($99/year)"
    echo "  2. Install 'Developer ID Application' certificate"
    echo "  3. Run: xcrun notarytool store-credentials 'notary-airplanetracker'"
    echo "  4. Run: ./Scripts/build-dmg.sh --signed"
fi
```

Make the script executable: `chmod +x Scripts/build-dmg.sh`.

Also, reference the entitlements file in the Xcode project. Check if the project's `build.settings` in `project.pbxproj` has a `CODE_SIGN_ENTITLEMENTS` key. If not, this will need to be set. Since modifying pbxproj directly is error-prone, document in the script output that users should set "Signing & Capabilities" > "Hardened Runtime" in Xcode and add the entitlements file there.

The key point: the entitlements file exists and is referenced by the build script's ad-hoc signing path. For Xcode-based signing (the --signed path), the entitlements are picked up automatically when the target's build settings reference them.
  </action>
  <verify>
Verify all files exist:
- `test -f AirplaneTracker3D/AirplaneTracker3D.entitlements && echo "entitlements OK"`
- `test -f ExportOptions.plist && echo "export options OK"`
- `test -x Scripts/build-dmg.sh && echo "build script OK and executable"`
- Grep for "com.apple.security.network.client" in entitlements file.
- Grep for "developer-id" in ExportOptions.plist.
- Build with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5` to confirm no regressions.
  </verify>
  <done>
Entitlements file grants network.client for hardened runtime. ExportOptions.plist configured for Developer ID distribution. Build script supports both unsigned (default, no Apple Developer Program needed) and --signed (full notarization) paths. Script creates a DMG with Applications drop link, handles both create-dmg and hdiutil fallback.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds with zero errors
2. Menu bar shows: App | File | Edit | View | Window | Tracker | Help
3. File menu has no "New Window" item
4. View menu has toggle items for info panel, statistics, and airport search
5. Tracker menu retains all 6 existing items with keyboard shortcuts
6. Cmd+W closes window, Cmd+Q quits, Cmd+, opens settings (system-provided)
7. Entitlements file contains network.client
8. build-dmg.sh is executable and has both signed/unsigned paths
</verification>

<success_criteria>
- Standard macOS menus (File, Edit, View, Window) appear alongside the existing Tracker menu
- File menu has no "New Window" (single-window app)
- View menu has toggle items for app panels
- Cmd+W, Cmd+Q, Cmd+, all function correctly
- Entitlements file with com.apple.security.network.client exists
- build-dmg.sh creates a DMG with Applications symlink
- Script documents both signed and unsigned distribution paths clearly
</success_criteria>

<output>
After completion, create `.planning/phases/10-native-macos-integration/10-02-SUMMARY.md`
</output>
