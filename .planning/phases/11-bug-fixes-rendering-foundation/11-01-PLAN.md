---
phase: 11-bug-fixes-rendering-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AirplaneTracker3D/Map/MapTileManager.swift
  - AirplaneTracker3D/Rendering/Renderer.swift
  - AirplaneTracker3D/Rendering/AircraftInstanceManager.swift
  - AirplaneTracker3D/Rendering/AircraftMeshLibrary.swift
autonomous: true

must_haves:
  truths:
    - "Map tiles load and render as textured surfaces on the ground plane within a few seconds of app launch"
    - "Propeller on small aircraft spins visibly around the Z axis at the nose position, aligned with aircraft heading"
    - "No placeholder gray tiles remain visible indefinitely for tiles that have valid server responses"
  artifacts:
    - path: "AirplaneTracker3D/Map/MapTileManager.swift"
      provides: "Debugged tile fetch pipeline with diagnostic logging and HTTP status handling"
      contains: "fetchTile"
    - path: "AirplaneTracker3D/Rendering/AircraftInstanceManager.swift"
      provides: "Corrected propeller spin matrix with real nose offset translation"
      contains: "noseOffset"
    - path: "AirplaneTracker3D/Rendering/AircraftMeshLibrary.swift"
      provides: "Propeller mesh centered at origin for clean rotation"
      contains: "buildPropeller"
  key_links:
    - from: "AirplaneTracker3D/Map/MapTileManager.swift"
      to: "AirplaneTracker3D/Rendering/Renderer.swift"
      via: "texture(for:) returns MTLTexture on cache hit"
      pattern: "tileManager\\.texture\\(for:"
    - from: "AirplaneTracker3D/Rendering/AircraftMeshLibrary.swift"
      to: "AirplaneTracker3D/Rendering/AircraftInstanceManager.swift"
      via: "Propeller mesh at origin + noseOffset translation = correct spin at nose"
      pattern: "noseOffset.*translationMatrix"
---

<objective>
Fix the two most critical rendering bugs: map tiles not displaying on the ground plane, and propeller rotation being incorrectly composed.

Purpose: Users currently see a blank/placeholder ground plane and propellers that don't spin correctly. These are the most visible bugs in v2.0.
Output: Working map tile pipeline, correctly spinning propellers aligned with aircraft nose.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-bug-fixes-rendering-foundation/11-RESEARCH.md
@AirplaneTracker3D/Map/MapTileManager.swift
@AirplaneTracker3D/Rendering/Renderer.swift
@AirplaneTracker3D/Rendering/AircraftInstanceManager.swift
@AirplaneTracker3D/Rendering/AircraftMeshLibrary.swift
@AirplaneTracker3D/Rendering/ThemeManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix map tile loading pipeline</name>
  <files>AirplaneTracker3D/Map/MapTileManager.swift, AirplaneTracker3D/Rendering/Renderer.swift</files>
  <action>
Debug and fix the map tile loading pipeline so tiles render on the ground plane instead of showing permanent placeholders.

**Step 1: Add diagnostic logging to MapTileManager.fetchTile()**

Add `#if DEBUG` print statements at each stage of the fetch pipeline:
- Before the HTTP request: log the tile coordinate and full URL being fetched
- After HTTP response: log status code and data byte count
- After MTKTextureLoader succeeds: log texture dimensions
- On any failure: log the full error with tile coordinate
- On cache store: log cache size after insertion

**Step 2: Investigate and fix the tile URL**

The Day theme uses `@2x.png` (retina) tiles from CartoDB: `https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png`. Some CDN edges may reject or redirect `@2x` requests. In `ThemeManager.tileURL(for:theme:)`, test if removing `@2x` fixes loading. If standard tiles load successfully, keep the non-retina URL. If `@2x` works fine, keep it.

Specifically in ThemeManager.swift, change the day theme URL from:
```
"https://\(subdomain).basemaps.cartocdn.com/light_all/\(tile.zoom)/\(tile.x)/\(tile.y)@2x.png"
```
to:
```
"https://\(subdomain).basemaps.cartocdn.com/light_all/\(tile.zoom)/\(tile.x)/\(tile.y).png"
```

Apply the same pattern to the night theme if it also uses `@2x` (currently it does NOT use @2x, so no change needed there).

**Step 3: Harden error handling in fetchTile()**

After the HTTP status check, also guard against empty data (0 bytes) which would cause MTKTextureLoader to fail:
```swift
if data.isEmpty {
    cacheQueue.sync { pendingRequests.remove(tile) }
    return
}
```

**Step 4: Verify the Renderer tile rendering path**

In Renderer.swift (lines 900-952), confirm the rendering path is correct:
- When `terrainMesh` exists AND `mapTexture` exists: terrain renders with map texture (correct path)
- When `terrainMesh` exists but `mapTexture` is nil: terrain renders with placeholder (green-gray) -- this is the state where terrain loads before map textures, causing the "no tiles" appearance
- When neither exists: flat quad placeholder (gray)

If terrain consistently loads before map textures, users would see green-gray terrain that eventually gets textured. This is expected behavior but may LOOK like "tiles not loading" if textures are slow. The diagnostic logging from Step 1 will confirm whether textures are loading at all.

**Important:** Do NOT add notification/callback patterns for tile readiness -- the 60fps polling pattern is adequate. Do NOT modify the terrain shader pipeline. The fix should be minimal: correct the URL if needed, add logging, and harden error handling.
  </action>
  <verify>
Build the project: `cd /Users/mit/Documents/GitHub/airplane-tracker-3d && xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5`

Verify no compile errors. The runtime verification (tiles actually loading) requires running the app and observing console output from the DEBUG logging.
  </verify>
  <done>
MapTileManager.fetchTile() has diagnostic logging at each pipeline stage. Tile URLs are using a format that CartoDB reliably serves. Empty data responses are guarded against. Project compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix propeller rotation matrix and mesh origin</name>
  <files>AirplaneTracker3D/Rendering/AircraftMeshLibrary.swift, AirplaneTracker3D/Rendering/AircraftInstanceManager.swift</files>
  <action>
Fix the propeller rotation so it spins visibly and correctly at the aircraft nose, aligned with the aircraft heading.

**Step 1: Move propeller mesh to origin in AircraftMeshLibrary.swift**

In `buildPropeller()`, change the propeller box offset from `(0, 0, 1.55)` to `(0, 0, 0)`. This centers the propeller geometry at the origin so rotationZ spins it around its own center, not around a point 1.55 units away. The nose positioning will be handled by the transform matrix in AircraftInstanceManager.

Change:
```swift
appendBox(vertices: &vertices, indices: &indices,
          size: SIMD3<Float>(0.08, 1.2, 0.08),
          offset: SIMD3<Float>(0, 0, 1.55))
```
To:
```swift
appendBox(vertices: &vertices, indices: &indices,
          size: SIMD3<Float>(0.08, 1.2, 0.08),
          offset: SIMD3<Float>(0, 0, 0))
```

**Step 2: Add a second perpendicular blade for visual clarity**

Add a second box perpendicular to the first (rotated 90 degrees) so the propeller looks like a cross-shaped prop when viewed from the front. This makes the spinning motion much more visible:

```swift
// Blade 1: vertical
appendBox(vertices: &vertices, indices: &indices,
          size: SIMD3<Float>(0.08, 1.2, 0.08),
          offset: SIMD3<Float>(0, 0, 0))
// Blade 2: horizontal (perpendicular)
appendBox(vertices: &vertices, indices: &indices,
          size: SIMD3<Float>(1.2, 0.08, 0.08),
          offset: SIMD3<Float>(0, 0, 0))
```

**Step 3: Fix noseOffset in AircraftInstanceManager.swift**

In the propeller spinning section (around line 192-194), change the noseOffset from identity to the actual nose position:

Change:
```swift
let noseOffset = translationMatrix(SIMD3<Float>(0, 0, 0)) // propeller mesh has built-in nose offset
```
To:
```swift
let noseOffset = translationMatrix(SIMD3<Float>(0, 0, 1.55)) // translate propeller to nose position
```

The resulting spin matrix `translation * rotation * noseOffset * propRotation` applies right-to-left:
1. `propRotation`: spin propeller at origin (XY plane rotation via rotationZ)
2. `noseOffset`: translate the spinning propeller to the nose position (Z=1.55)
3. `rotation`: rotate entire assembly by aircraft heading (around Y)
4. `translation`: move to world position

This is the clean, maintainable pattern: mesh at origin, transform positions it.

**Important:** Do NOT modify helicopter rotor code -- it uses a different rotation pattern (rotationY around world Y) that works correctly for flat rotors. Do NOT touch any shader code. The propeller fix is purely CPU-side matrix composition.
  </action>
  <verify>
Build the project: `cd /Users/mit/Documents/GitHub/airplane-tracker-3d && xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5`

Verify no compile errors. Verify in AircraftMeshLibrary.swift that the propeller offset is `(0, 0, 0)` and in AircraftInstanceManager.swift that noseOffset uses `(0, 0, 1.55)`.
  </verify>
  <done>
Propeller mesh is centered at origin (0,0,0) with a cross-shaped two-blade design. The noseOffset in AircraftInstanceManager translates the propeller to Z=1.55 (nose position). The spin matrix correctly composes: spin at origin -> translate to nose -> rotate by heading -> translate to world. Project compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild` succeeds with zero errors for the Debug scheme
2. MapTileManager has DEBUG logging at fetch, response, texture creation, and failure stages
3. Tile URL for day theme uses a format that CartoDB can serve reliably
4. Propeller mesh offset is (0, 0, 0) in AircraftMeshLibrary.swift buildPropeller()
5. noseOffset in AircraftInstanceManager.swift is translationMatrix(SIMD3<Float>(0, 0, 1.55))
6. Propeller has two perpendicular blades for visible spinning
</verification>

<success_criteria>
- Project builds cleanly
- Map tile fetch pipeline has diagnostic logging and hardened error handling
- Propeller geometry and rotation matrix follow the clean pattern: mesh at origin, transform positions and spins
</success_criteria>

<output>
After completion, create `.planning/phases/11-bug-fixes-rendering-foundation/11-01-SUMMARY.md`
</output>
