---
phase: 12-info-panel-restoration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AirplaneTracker3D/Views/AircraftDetailPanel.swift
  - AirplaneTracker3D/DataLayer/EnrichmentService.swift
autonomous: true

must_haves:
  truths:
    - "User sees latitude and longitude coordinates in the aircraft detail panel when an aircraft is selected"
    - "User can click links to FlightAware, ADS-B Exchange, and planespotters.net that open in the default browser with the correct aircraft/flight pre-filled"
    - "User sees an aircraft photo in the detail panel fetched from planespotters.net API (with hexdb.io fallback), with a placeholder shown while loading or if unavailable"
  artifacts:
    - path: "AirplaneTracker3D/Views/AircraftDetailPanel.swift"
      provides: "Complete detail panel with lat/lon, external links section, and async aircraft photo"
      contains: "NSWorkspace.shared.open"
      min_lines: 200
    - path: "AirplaneTracker3D/DataLayer/EnrichmentService.swift"
      provides: "Photo URL fetching from planespotters.net API with hexdb.io fallback"
      contains: "fetchPhotoURL"
  key_links:
    - from: "AirplaneTracker3D/Views/AircraftDetailPanel.swift"
      to: "AirplaneTracker3D/DataLayer/EnrichmentService.swift"
      via: "Panel calls enrichmentService.fetchPhotoURL(hex:) to get photo URL"
      pattern: "enrichmentService\\.fetchPhotoURL"
    - from: "AirplaneTracker3D/Views/AircraftDetailPanel.swift"
      to: "NSWorkspace.shared.open"
      via: "External link buttons open URLs in default browser"
      pattern: "NSWorkspace\\.shared\\.open"
---

<objective>
Add external links, aircraft photo, and verify lat/lon display in the aircraft detail panel.

Purpose: The native detail panel is missing key features that the web version has — external links to flight tracking sites and aircraft photos. Lat/lon is already displayed but needs verification. This plan restores full information density parity with the web version.
Output: Complete AircraftDetailPanel with external links section, async photo loading, and verified lat/lon display.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@AirplaneTracker3D/Views/AircraftDetailPanel.swift
@AirplaneTracker3D/DataLayer/EnrichmentService.swift
@AirplaneTracker3D/Models/AircraftModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add photo URL fetching to EnrichmentService</name>
  <files>AirplaneTracker3D/DataLayer/EnrichmentService.swift</files>
  <action>
Add a `fetchPhotoURL(hex:)` method to EnrichmentService that returns an optional URL string for an aircraft photo.

**Photo API strategy (two sources with fallback):**

1. **Primary: planespotters.net API** — `https://api.planespotters.net/pub/photos/hex/{hex}`
   - Returns JSON with `photos` array, each having `thumbnail_large.src` or `thumbnail.src`
   - Parse response, extract the first photo's `thumbnail_large.src` URL string
   - This is a public API, no API key needed

2. **Fallback: hexdb.io** — `https://hexdb.io/hex-image?hex={hex}`
   - Returns a redirect to an image URL or 404
   - If planespotters returns no photos, try hexdb as fallback
   - For hexdb, just return the URL string directly (the image endpoint itself)

**Implementation details:**

- Add a `photoCache: [String: String?]` dictionary (same pattern as aircraftCache/routeCache) to cache photo URLs including negative lookups
- Create Codable structs for the planespotters response:
  ```
  struct PlanespottersResponse: Codable {
      let photos: [PlanespottersPhoto]?
  }
  struct PlanespottersPhoto: Codable {
      let thumbnail_large: PhotoSize?
      let thumbnail: PhotoSize?
  }
  struct PhotoSize: Codable {
      let src: String?
  }
  ```
- Method signature: `func fetchPhotoURL(hex: String) async -> String?`
- Try planespotters first. If it returns photos, use `photos[0].thumbnail_large?.src ?? photos[0].thumbnail?.src`
- If planespotters fails or returns empty photos array, return `"https://hexdb.io/hex-image?hex=\(hex)"` as a best-effort URL (hexdb returns the image directly at this URL, but may 404 — the SwiftUI AsyncImage will handle that gracefully with its placeholder)
- Cache the result (or nil for negative lookups)
- Use the same `session` (3s timeout) already defined in the actor

**Important:** Keep all new types private to the actor. Follow the exact same caching and error handling pattern as fetchAircraftInfo and fetchRouteInfo.
  </action>
  <verify>Build the project with Cmd+B — no compiler errors. The new method exists on EnrichmentService and returns `String?`.</verify>
  <done>EnrichmentService has fetchPhotoURL(hex:) that queries planespotters.net API with hexdb.io fallback, caches results, and returns an optional photo URL string.</done>
</task>

<task type="auto">
  <name>Task 2: Add external links and aircraft photo to detail panel</name>
  <files>AirplaneTracker3D/Views/AircraftDetailPanel.swift</files>
  <action>
Enhance AircraftDetailPanel.swift with two new sections: external links and aircraft photo.

**1. Add state for photo URL:**
```swift
@State private var photoURL: String?
```

**2. Add External Links section** (after the Route section, before the loading indicator):

Add a new section with header "Links" containing three clickable buttons:
- **FlightAware**: `https://flightaware.com/live/flight/{callsign}` (only if callsign is non-empty)
- **ADS-B Exchange**: `https://globe.adsbexchange.com/?icao={hex}`
- **planespotters.net**: `https://www.planespotters.net/hex/{hex}`

Use `NSWorkspace.shared.open(url)` to open each link in the default browser. Style as horizontal row of small blue link buttons:
```swift
sectionHeader("Links")
HStack(spacing: 12) {
    if !aircraft.callsign.isEmpty {
        linkButton("FlightAware", url: "https://flightaware.com/live/flight/\(aircraft.callsign.trimmingCharacters(in: .whitespaces))")
    }
    linkButton("ADS-B Exchange", url: "https://globe.adsbexchange.com/?icao=\(aircraft.hex)")
    linkButton("Planespotters", url: "https://www.planespotters.net/hex/\(aircraft.hex)")
}
```

Add a private helper method:
```swift
private func linkButton(_ title: String, url: String) -> some View {
    Button(action: {
        if let url = URL(string: url) {
            NSWorkspace.shared.open(url)
        }
    }) {
        Text(title)
            .font(.caption)
            .foregroundColor(.blue)
            .underline()
    }
    .buttonStyle(.plain)
}
```

**3. Add Aircraft Photo section** (after enrichment data loads, before the Follow button):

Show a photo using AsyncImage when a photoURL is available:
```swift
if let urlStr = photoURL, let url = URL(string: urlStr) {
    AsyncImage(url: url) { phase in
        switch phase {
        case .success(let image):
            image
                .resizable()
                .aspectRatio(contentMode: .fill)
                .frame(maxWidth: .infinity, maxHeight: 120)
                .clipped()
                .cornerRadius(8)
        case .failure:
            // Show nothing on failure — photo is optional
            EmptyView()
        case .empty:
            // Loading placeholder
            RoundedRectangle(cornerRadius: 8)
                .fill(Color.gray.opacity(0.2))
                .frame(maxWidth: .infinity, maxHeight: 120)
                .overlay(ProgressView().tint(.gray))
        @unknown default:
            EmptyView()
        }
    }
}
```

**4. Update the .task modifier** to also fetch the photo URL:

Add `async let photoInfo = enrichmentService.fetchPhotoURL(hex: aircraft.hex)` alongside the existing async let calls, and set `photoURL = await photoInfo` after the other assignments.

**5. Verify lat/lon section** — The panel already has a Position section displaying lat/lon (lines 52-56 in current code). Verify it remains intact and correct. No changes needed to this section.

**Important notes:**
- `import AppKit` is needed for `NSWorkspace` — add if not already imported (SwiftUI on macOS includes it, but be explicit)
- Keep the Divider().background(Color.gray) pattern between sections
- Place Links section after Route (or after Aircraft if no route), with a Divider before it
- Place Photo between the Links section and the Spacer/Follow button area
  </action>
  <verify>Build the project with Cmd+B — no compiler errors. Launch the app, select an aircraft. Verify: (1) lat/lon displayed in Position section, (2) external link buttons visible, (3) clicking a link opens the browser, (4) photo loads or shows placeholder.</verify>
  <done>Detail panel shows external links (FlightAware, ADS-B Exchange, planespotters.net) that open in default browser, and displays an aircraft photo fetched asynchronously with a loading placeholder. Lat/lon position section remains intact.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `swift build` or Xcode build succeeds with no errors
- [ ] Position section displays lat/lon when aircraft is selected (INFO-01)
- [ ] External links section shows FlightAware, ADS-B Exchange, planespotters.net buttons (INFO-02)
- [ ] Clicking any link opens the correct URL in default browser (INFO-02)
- [ ] FlightAware link uses callsign, ADS-B Exchange and planespotters use hex (INFO-02)
- [ ] Aircraft photo loads from planespotters.net or hexdb.io when available (INFO-03)
- [ ] Photo area shows a loading placeholder while fetching (INFO-03)
- [ ] Photo area gracefully handles missing photos (no crash, no broken image) (INFO-03)
- [ ] EnrichmentService caches photo URL lookups including negative results
</verification>

<success_criteria>
- All tasks completed
- All three INFO requirements satisfied (INFO-01, INFO-02, INFO-03)
- No regressions in existing detail panel functionality (flight data, enrichment, route display)
- Clean build with no warnings related to new code
</success_criteria>

<output>
After completion, create `.planning/phases/12-info-panel-restoration/12-01-SUMMARY.md`
</output>
