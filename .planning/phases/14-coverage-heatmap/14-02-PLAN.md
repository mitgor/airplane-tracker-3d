---
phase: 14-coverage-heatmap
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - AirplaneTracker3D/Rendering/Renderer.swift
  - AirplaneTracker3D/Views/SettingsView.swift
  - AirplaneTracker3D/AirplaneTracker3DApp.swift
  - AirplaneTracker3D/Rendering/ThemeManager.swift
autonomous: true

must_haves:
  truths:
    - "User sees a color-mapped ground overlay showing aircraft detection density that updates as new aircraft positions are received"
    - "User can toggle the coverage heatmap on and off without affecting other map layers"
  artifacts:
    - path: "AirplaneTracker3D/Rendering/Renderer.swift"
      provides: "Heatmap pipeline state, HeatmapManager integration, draw call in render loop"
      contains: "heatmapManager"
    - path: "AirplaneTracker3D/Views/SettingsView.swift"
      provides: "Coverage Heatmap toggle in Rendering tab"
      contains: "showHeatmap"
    - path: "AirplaneTracker3D/AirplaneTracker3DApp.swift"
      provides: "UserDefaults.register default for showHeatmap"
      contains: "showHeatmap"
    - path: "AirplaneTracker3D/Rendering/ThemeManager.swift"
      provides: "heatmapColorRamp property on ThemeConfig"
      contains: "heatmapColorRamp"
  key_links:
    - from: "AirplaneTracker3D/Rendering/Renderer.swift"
      to: "AirplaneTracker3D/Rendering/HeatmapManager.swift"
      via: "heatmapManager.accumulate() and heatmapManager.update() called each frame"
      pattern: "heatmapManager\\.(accumulate|update)"
    - from: "AirplaneTracker3D/Rendering/Renderer.swift"
      to: "AirplaneTracker3D/Rendering/HeatmapShaders.metal"
      via: "heatmapPipeline uses heatmap_vertex and heatmap_fragment functions"
      pattern: "heatmap_vertex|heatmap_fragment"
    - from: "AirplaneTracker3D/Views/SettingsView.swift"
      to: "AirplaneTracker3D/Rendering/Renderer.swift"
      via: "@AppStorage showHeatmap -> UserDefaults -> Renderer draw() reads bool"
      pattern: "showHeatmap"
---

<objective>
Wire HeatmapManager into the Renderer draw loop, create the pipeline state, add the Settings toggle, and register the UserDefaults default -- completing the full coverage heatmap feature.

Purpose: Connects the data pipeline (Plan 01) to the rendering pipeline and user controls, fulfilling HEAT-01 (visible heatmap) and HEAT-02 (toggle on/off).
Output: Updated Renderer.swift, SettingsView.swift, AirplaneTracker3DApp.swift, ThemeManager.swift
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-coverage-heatmap/14-01-SUMMARY.md
@AirplaneTracker3D/Rendering/Renderer.swift
@AirplaneTracker3D/Rendering/HeatmapManager.swift
@AirplaneTracker3D/Rendering/HeatmapShaders.metal
@AirplaneTracker3D/Rendering/ShaderTypes.h
@AirplaneTracker3D/Views/SettingsView.swift
@AirplaneTracker3D/AirplaneTracker3DApp.swift
@AirplaneTracker3D/Rendering/ThemeManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heatmap color ramp to ThemeConfig and register UserDefaults default</name>
  <files>AirplaneTracker3D/Rendering/ThemeManager.swift, AirplaneTracker3D/AirplaneTracker3DApp.swift</files>
  <action>
**ThemeManager.swift:**

Add a `heatmapColorRamp` property to `ThemeConfig`. This is a tuple of two SIMD4<Float> values representing the low-intensity and high-intensity colors for the heatmap gradient. The HeatmapManager will interpolate between these based on cell density.

```swift
let heatmapColorRamp: (low: SIMD4<Float>, high: SIMD4<Float>)
```

Add values to each theme config in `ThemeManager.configs`:
- Day: low = (0, 0.39, 1.0, 0.15), high = (0, 1.0, 1.0, 0.6) -- blue to cyan
- Night: low = (0, 0.31, 0.71, 0.15), high = (0, 1.0, 1.0, 0.7) -- dark-blue to bright-cyan
- Retro: low = (0, 0.24, 0, 0.15), high = (0, 1.0, 0, 0.7) -- dark-green to bright-green

**AirplaneTracker3DApp.swift:**

Add `"showHeatmap": true` to the `UserDefaults.standard.register(defaults:)` dictionary alongside the existing airspace toggle defaults. This ensures `UserDefaults.standard.bool(forKey: "showHeatmap")` returns `true` by default.
  </action>
  <verify>Project builds. ThemeConfig has heatmapColorRamp on all three themes. `UserDefaults.standard.register` includes "showHeatmap".</verify>
  <done>ThemeConfig has heatmapColorRamp tuple for all three themes. showHeatmap defaults to true in UserDefaults registration.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate HeatmapManager into Renderer and add Settings toggle</name>
  <files>AirplaneTracker3D/Rendering/Renderer.swift, AirplaneTracker3D/Views/SettingsView.swift</files>
  <action>
**Renderer.swift -- Pipeline State (in init):**

Add a new stored property `let heatmapPipeline: MTLRenderPipelineState` and `let heatmapManager: HeatmapManager`.

In `init(metalView:)`, after the airspace pipeline setup block, create the heatmap pipeline state:
- vertexFunction: `library.makeFunction(name: "heatmap_vertex")`
- fragmentFunction: `library.makeFunction(name: "heatmap_fragment")`
- Alpha blending enabled (same as airspace fill: sourceRGBBlendFactor = .sourceAlpha, destinationRGBBlendFactor = .oneMinusSourceAlpha, same for alpha channel)
- No vertex descriptor needed (reading raw buffer by vertexID)
- depthAttachmentPixelFormat, rasterSampleCount from metalView
- Initialize: `heatmapManager = HeatmapManager(device: device)`

**Renderer.swift -- Draw Loop (in draw(in:)):**

1. Read setting: `let showHeatmap = UserDefaults.standard.bool(forKey: "showHeatmap")` (add near the existing `showAirspace` read around line 919).

2. Accumulate heatmap data: After the `states` array is computed (around line 1088), if `showHeatmap && !states.isEmpty`:
   - Compute visible bounds using the existing `computeVisibleBounds()` method
   - Call `heatmapManager.accumulate(states: states, west: bounds.west, south: bounds.south, east: bounds.east, north: bounds.north)`

3. Update heatmap buffers: Call `heatmapManager.update(bufferIndex: currentBufferIndex, themeConfig: config)` (after the airspace update, around line 957).

4. Render heatmap: Create a private `encodeHeatmap(encoder:uniformBuffer:)` method following the `encodeAirspaceVolumes` pattern:
   - Guard `heatmapManager.hasData` and heatmapTexture is not nil
   - Set pipeline state to `heatmapPipeline`
   - Set depth stencil to `glowDepthStencilState` (depth read, no write -- semi-transparent overlay)
   - Set cull mode to `.none`
   - Bind uniforms at BufferIndexUniforms
   - Bind heatmap vertex buffer at BufferIndexHeatmapVertices
   - Bind heatmap texture at fragment texture index 0
   - `drawPrimitives(type: .triangle, vertexStart: 0, vertexCount: heatmapManager.vertexCount())`

5. Call `encodeHeatmap` in the draw loop: Place it right AFTER the tile rendering loop and BEFORE the aircraft rendering. This way the heatmap sits on the ground plane (above map tiles, below aircraft/trails/labels). Wrap with `if showHeatmap { encodeHeatmap(...) }`. It should be rendered both in the `if !states.isEmpty` branch and the `else` branch (like airspace volumes), so the heatmap persists even when no aircraft are currently visible.

**SettingsView.swift:**

Add `@AppStorage("showHeatmap") private var showHeatmap: Bool = true` in the Rendering Settings section.

In `renderingTab`, add a new Section after the "Airspace Volumes" section:

```swift
Section("Coverage Heatmap") {
    Toggle("Show Heatmap", isOn: $showHeatmap)
}
```

Keep it simple -- a single toggle. No sub-options needed (unlike airspace which has per-class toggles).
  </action>
  <verify>
1. `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D build 2>&1 | tail -5` shows BUILD SUCCEEDED
2. Renderer.swift contains heatmapManager, heatmapPipeline, encodeHeatmap method, and showHeatmap UserDefaults read
3. SettingsView.swift contains showHeatmap toggle in a "Coverage Heatmap" section
  </verify>
  <done>
- Renderer creates heatmap pipeline state and HeatmapManager in init
- Draw loop accumulates aircraft positions into heatmap, updates buffers, and renders the textured ground quad with alpha blending
- Heatmap renders after map tiles but before aircraft (correct layer order)
- showHeatmap toggle in Settings controls visibility
- Heatmap persists on screen even when no aircraft are currently visible (accumulated data remains)
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild build` passes
2. HEAT-01: Renderer draw loop calls heatmapManager.accumulate() with aircraft states and renders the heatmap texture as a ground overlay
3. HEAT-02: Settings has "Show Heatmap" toggle, Renderer reads showHeatmap from UserDefaults and conditionally renders
4. Heatmap renders between map tiles and aircraft (correct z-ordering)
5. Theme-aware colors: ThemeConfig.heatmapColorRamp drives the color gradient
</verification>

<success_criteria>
- App builds and runs with coverage heatmap visible on the ground plane
- Heatmap shows blue-cyan gradient (day), dark-blue-to-cyan (night), or green (retro) density overlay that updates as aircraft fly
- Toggle in Settings -> Rendering -> "Show Heatmap" controls visibility without affecting map tiles, aircraft, trails, airspace, or labels
- Zero-density cells are fully transparent; high-density cells are more opaque
- Heatmap resets when camera moves significantly (>50% shift in view bounds)
</success_criteria>

<output>
After completion, create `.planning/phases/14-coverage-heatmap/14-02-SUMMARY.md`
</output>
