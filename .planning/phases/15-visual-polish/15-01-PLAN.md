---
phase: 15-visual-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AirplaneTracker3D/Rendering/Renderer.swift
  - AirplaneTracker3D/Rendering/TerrainTileManager.swift
  - AirplaneTracker3D/ContentView.swift
autonomous: true

must_haves:
  truths:
    - "User sees higher-resolution terrain tiles near the camera and lower-resolution tiles far away"
    - "User sees smooth spring-animated transitions when showing and hiding the detail panel, search panel, info panel, and statistics panel"
  artifacts:
    - path: "AirplaneTracker3D/Rendering/Renderer.swift"
      provides: "Multi-zoom tile selection in draw loop"
      contains: "lodZoom"
    - path: "AirplaneTracker3D/Rendering/TerrainTileManager.swift"
      provides: "Terrain mesh LOD cache supporting multiple zoom levels"
    - path: "AirplaneTracker3D/ContentView.swift"
      provides: "Spring animation modifiers on all panel transitions"
      contains: ".spring"
  key_links:
    - from: "Renderer.swift draw loop"
      to: "TerrainTileManager + MapTileManager"
      via: "per-tile zoom computed from camera distance to tile center"
      pattern: "lodZoom"
---

<objective>
Add distance-based terrain level of detail and spring-animated panel transitions.

Purpose: VIS-01 gives users higher visual fidelity near the camera without overloading distant tile fetching. VIS-02 gives panels a polished, native feel with spring physics instead of linear easing.
Output: Modified Renderer with multi-zoom tile grid, updated ContentView with spring animations.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@AirplaneTracker3D/Rendering/Renderer.swift
@AirplaneTracker3D/Rendering/TerrainTileManager.swift
@AirplaneTracker3D/Map/MapTileManager.swift
@AirplaneTracker3D/Map/TileCoordinate.swift
@AirplaneTracker3D/Camera/OrbitCamera.swift
@AirplaneTracker3D/ContentView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Distance-based terrain level of detail</name>
  <files>
    AirplaneTracker3D/Rendering/Renderer.swift
    AirplaneTracker3D/Rendering/TerrainTileManager.swift
  </files>
  <action>
Currently the Renderer computes a single `currentZoom` from camera distance and loads ALL visible tiles at that zoom level. Change the tile selection to use multiple zoom levels based on each tile's distance from the camera.

**In Renderer.swift -- replace the single-zoom visible tile computation with a multi-zoom approach:**

1. Keep the existing `currentZoom` computation as the "base" zoom level.
2. Create a new method `func lodTiles(centerLat:centerLon:baseZoom:cameraPosition:) -> [TileCoordinate]` that:
   - Loads tiles in concentric rings from the camera center.
   - Ring 0 (center tile + immediate neighbors, radius 1): use `baseZoom + 1` (capped at 12). These are the nearest, highest-detail tiles.
   - Ring 1 (radius 2-3): use `baseZoom` (the standard zoom). Medium detail.
   - Ring 2 (radius 4-5): use `baseZoom - 1` (floored at 6). Distant, lower detail.
   - Deduplicate tiles: since different zoom levels cover different geographic areas, each ring should only include tiles at its assigned zoom level. For each ring, compute `TileCoordinate.visibleTiles(centerLat:centerLon:zoom:radius:)` and subtract tiles already covered by higher-zoom inner rings.
   - A simpler approach: just call `visibleTiles` three times at three zoom levels with different radii, and let all three sets render. The terrain/map caches already handle multi-zoom. The key is: small radius at high zoom (near), medium radius at base zoom (mid), and large radius at low zoom (far). This naturally gives LOD.

3. Replace the existing `let visibleTiles = TileCoordinate.visibleTiles(...)` block with a call to the new `lodTiles()` method. The returned array may contain tiles at different zoom levels.

4. The draw loop already iterates `for tile in visibleTiles` and calls `tileManager.texture(for: tile)` and `terrainTileManager.terrainMesh(for: tile)` -- both already support arbitrary zoom levels and cache by TileCoordinate (which includes zoom). So no changes needed to the rendering code itself.

**Specific zoom radii (tuned for performance):**
- Near ring: zoom = min(baseZoom + 1, 12), radius = 1
- Mid ring: zoom = baseZoom, radius = tileRadius(forZoom: baseZoom) (existing method)
- Far ring: zoom = max(baseZoom - 1, 6), radius = 2

**In TerrainTileManager.swift:**
- Increase `maxCacheSize` from 150 to 250 to accommodate tiles at multiple zoom levels.

**Important:** Do NOT change MapTileManager's maxCacheSize -- it's already 300 which is sufficient. Do NOT change any shader code. Do NOT change how terrain meshes are built -- different zoom tiles will naturally have different geographic extents and thus different detail levels.

**Performance guard:** The total tile count should stay reasonable. Near ring (3x3=9) + Mid ring (~81 minus overlap ~9 = ~72) + Far ring (~25 minus overlap = ~15-20) = ~100 tiles total. This is comparable to the current ~81-121 tiles at single zoom.
  </action>
  <verify>
Build the project with `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5` -- must compile without errors. Visually confirm: when zoomed in, tiles near camera center appear more detailed (smaller tile footprint = more pixels per area) than tiles at the edges.
  </verify>
  <done>
Renderer renders tiles at 3 different zoom levels simultaneously: higher zoom near camera, base zoom at mid-range, lower zoom far away. Terrain meshes and map textures load at their respective zoom levels. Build succeeds with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Spring-animated panel transitions</name>
  <files>AirplaneTracker3D/ContentView.swift</files>
  <action>
Replace all `withAnimation(.easeInOut(duration: ...))` calls and `.transition(...)` modifiers in ContentView with spring animations for a more native feel.

**Changes in ContentView.swift:**

1. Replace `withAnimation(.easeInOut(duration: 0.25))` on aircraft selection (line ~46-48 and ~141-142) with `withAnimation(.spring(response: 0.35, dampingFraction: 0.8))`.

2. Replace `withAnimation(.easeInOut(duration: 0.2))` on search panel toggle (lines ~70-72 and ~177-179) with `withAnimation(.spring(response: 0.3, dampingFraction: 0.85))`.

3. Replace `withAnimation(.easeInOut(duration: 0.2))` on info panel toggle (line ~191-193) with `withAnimation(.spring(response: 0.3, dampingFraction: 0.85))`.

4. Replace `withAnimation(.easeInOut(duration: 0.2))` on stats panel toggle (line ~195-197) with `withAnimation(.spring(response: 0.3, dampingFraction: 0.85))`.

5. Update transition modifiers to use spring-compatible transitions:
   - AircraftDetailPanel `.transition(.move(edge: .trailing))` -> `.transition(.move(edge: .trailing).combined(with: .opacity))` (keeps slide, adds opacity for smoother spring overshoot).
   - InfoPanel `.transition(.opacity)` stays as-is (opacity works well with spring).
   - StatisticsPanel `.transition(.move(edge: .bottom))` -> `.transition(.move(edge: .bottom).combined(with: .opacity))`.

**Do NOT** change any panel content, sizing, or layout. Only animation timing curves and transition combinations.
  </action>
  <verify>
Build succeeds. Search in ContentView.swift for `.easeInOut` -- should return zero matches. Search for `.spring` -- should find at least 4 matches.
  </verify>
  <done>
All panel show/hide transitions use spring animations with appropriate response and damping values. No easeInOut animations remain in ContentView. Build compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D build` succeeds
2. Renderer's draw loop renders tiles at multiple zoom levels (grep for `lodTiles` or multi-zoom logic)
3. ContentView uses `.spring()` animations exclusively (grep for `.spring` confirms, grep for `.easeInOut` returns nothing)
4. No regressions: terrain still renders with elevation, panels still show/hide correctly
</verification>

<success_criteria>
- Terrain tiles render at 3 zoom levels: higher near camera, base at mid-range, lower far away
- All 4 panel transitions (detail, search, info, stats) use spring physics
- Project compiles and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-visual-polish/15-01-SUMMARY.md`
</output>
