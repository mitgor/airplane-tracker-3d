---
phase: 17-expanded-airport-database
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AirplaneTracker3D/Data/airports.json
  - AirplaneTracker3D/Rendering/AirportLabelManager.swift
autonomous: true

must_haves:
  truths:
    - "Airport database contains approximately 500 major worldwide airports with scheduled commercial service"
    - "User can search for Berlin and get Berlin Brandenburg (BER) as a result"
    - "User can search by name, IATA code, or ICAO code and get correct matches for all airports"
    - "Airport labels render on the 3D map for all airports in the expanded database"
    - "Distance culling still works correctly -- only nearby airports show labels"
  artifacts:
    - path: "AirplaneTracker3D/Data/airports.json"
      provides: "Complete worldwide airport database"
      contains: "EDDB"
    - path: "AirplaneTracker3D/Rendering/AirportLabelManager.swift"
      provides: "Atlas sized for 512 slots"
      contains: "2048"
  key_links:
    - from: "AirplaneTracker3D/Data/airports.json"
      to: "AirplaneTracker3D/Rendering/AirportLabelManager.swift"
      via: "loadAirports() decoding same JSON format"
      pattern: "decode.*AirportData"
    - from: "AirplaneTracker3D/Data/airports.json"
      to: "AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift"
      via: "init() decoding same JSON format"
      pattern: "decode.*AirportData"
---

<objective>
Expand the airport database from 99 to ~500 major worldwide airports and update the
label atlas to accommodate the larger dataset.

Purpose: Users currently cannot find many major world airports (Berlin, Rome Fiumicino,
Bangkok, etc.) because the database is heavily US-biased with only 99 entries. Expanding
to ~500 airports with global coverage fixes search results and gives worldwide label
visibility.

Output: Updated airports.json with ~500 entries, AirportLabelManager with atlas sized
for 512 slots.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@AirplaneTracker3D/Data/airports.json
@AirplaneTracker3D/Rendering/AirportLabelManager.swift
@AirplaneTracker3D/ViewModels/AirportSearchViewModel.swift
@AirplaneTracker3D/Models/AircraftModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate expanded airports.json with ~500 worldwide airports</name>
  <files>AirplaneTracker3D/Data/airports.json</files>
  <action>
Replace the current airports.json (99 entries) with a comprehensive list of approximately
500 major worldwide airports that have significant scheduled commercial service.

JSON format MUST remain identical -- array of objects with these exact fields:
```json
{"icao":"EDDB","iata":"BER","name":"Berlin Brandenburg Airport","lat":52.3667,"lon":13.5033,"type":"large_airport"}
```

Fields: icao (string), iata (string or null), name (string), lat (number), lon (number),
type (string -- use "large_airport" for all entries).

Coverage requirements (approximate targets -- ensure balanced global representation):
- North America: ~100 airports (US major + medium hubs, Canada top 10, Mexico top 10, Caribbean hubs)
- Europe: ~120 airports (all EU capitals, major hubs like LHR/CDG/FRA/AMS/MAD/BCN/FCO/MUC, plus regional like BER/HAM/STR/LYS/NAP/PRG/BUD/OTP/ATH/HEL/OSL/ARN/CPH)
- Asia-Pacific: ~120 airports (China top 20, Japan top 10, India top 15, Southeast Asia major hubs, South Korea, Taiwan, Australia, New Zealand)
- Middle East: ~30 airports (UAE, Saudi, Qatar, Oman, Kuwait, Bahrain, Israel, Jordan, Lebanon)
- Africa: ~30 airports (South Africa, Egypt, Morocco, Nigeria, Kenya, Ethiopia, Tanzania, Ghana, Senegal, Tunisia, Algeria)
- South America: ~30 airports (Brazil top 10, Argentina, Chile, Colombia, Peru, Ecuador, Venezuela)
- Central America/Caribbean: ~20 airports (Panama, Costa Rica, Jamaica, Dominican Republic, Puerto Rico, Cuba, Trinidad, Bahamas)

CRITICAL airports that MUST be included (these were reported missing):
- EDDB / BER -- Berlin Brandenburg Airport (lat: 52.3667, lon: 13.5033)
- EDDH / HAM -- Hamburg Airport
- EDDS / STR -- Stuttgart Airport
- LSZH / ZRH -- Zurich Airport (already in current data -- keep it)
- LOWW / VIE -- Vienna International Airport (already in current data -- keep it)
- LKPR / PRG -- Vaclav Havel Airport Prague
- LHBP / BUD -- Budapest Ferenc Liszt International Airport
- LGAV / ATH -- Athens International Airport
- LROP / OTP -- Henri Coanda International Airport Bucharest

Keep ALL 99 airports from the current database (do not remove any existing entries).
Add approximately 400 new airports to reach ~500 total.

Use accurate coordinates. For airports already in the file, keep the existing coordinates.
For new airports, use coordinates accurate to 4 decimal places sourced from common
aviation databases (OurAirports-derived data).

Sort the final JSON array by ICAO code alphabetically for easy diffing and maintenance.

Validate: The file must be valid JSON. Every entry must have all 6 fields. No duplicate
ICAO codes. IATA codes should be unique where present (null is acceptable for airports
without IATA codes).
  </action>
  <verify>
Run in the project directory:
1. `python3 -c "import json; d=json.load(open('AirplaneTracker3D/Data/airports.json')); print(f'Count: {len(d)}'); assert len(d) >= 480, f'Too few: {len(d)}'; assert len(d) <= 520, f'Too many: {len(d)}'"` -- confirms valid JSON with ~500 entries
2. `python3 -c "import json; d=json.load(open('AirplaneTracker3D/Data/airports.json')); icaos=[a['icao'] for a in d]; assert 'EDDB' in icaos, 'Missing Berlin'; assert 'KATL' in icaos, 'Missing Atlanta'; assert len(icaos)==len(set(icaos)), 'Duplicate ICAO codes'; print('Berlin and Atlanta present, no duplicates')"` -- confirms Berlin present, no duplicates
3. `python3 -c "import json; d=json.load(open('AirplaneTracker3D/Data/airports.json')); [a for a in d if not all(k in a for k in ['icao','iata','name','lat','lon','type'])] or print('All fields present')"` -- confirms schema consistency
  </verify>
  <done>airports.json contains ~500 airports with global coverage, Berlin Brandenburg (BER/EDDB) is present, all existing 99 airports are preserved, JSON format unchanged, no duplicate ICAO codes.</done>
</task>

<task type="auto">
  <name>Task 2: Update AirportLabelManager atlas dimensions for 512 slots</name>
  <files>AirplaneTracker3D/Rendering/AirportLabelManager.swift</files>
  <action>
Update the atlas constants in AirportLabelManager to support 512 label slots (up from 128).

Current values:
```swift
private let atlasWidth = 1024
private let atlasHeight = 512
private let slotWidth = 128
private let slotHeight = 32
private let columnsPerRow = 8   // 1024 / 128
private let rowCount = 16       // 512 / 32
private var maxSlots: Int { columnsPerRow * rowCount }  // 128
```

New values:
```swift
private let atlasWidth = 2048
private let atlasHeight = 1024
private let slotWidth = 128
private let slotHeight = 32
private let columnsPerRow = 16  // 2048 / 128
private let rowCount = 32       // 1024 / 32
private var maxSlots: Int { columnsPerRow * rowCount }  // 512
```

This doubles both atlas dimensions (1024x512 -> 2048x1024), keeping slot size at 128x32
but increasing the grid from 8x16 to 16x32 = 512 slots. The 2048x1024 RGBA texture is
8 MB of VRAM -- well within Metal limits.

Do NOT change:
- slotWidth or slotHeight (128x32 is fine for IATA/ICAO codes)
- maxVisibleLabels (40 per frame is correct for performance)
- maxDistance or fadeDistance (400 and 200 world units are correct)
- Any rendering logic, distance culling, sorting, or UV calculation code
- The AirportData struct
- The loadAirports() function
- Any other file

Only these 4 constant values change: atlasWidth, atlasHeight, columnsPerRow, rowCount.
The maxSlots computed property automatically becomes 512 (16 * 32).
  </action>
  <verify>
1. `grep -n "atlasWidth\|atlasHeight\|columnsPerRow\|rowCount" AirplaneTracker3D/Rendering/AirportLabelManager.swift` -- confirms new values (2048, 1024, 16, 32)
2. Build the project: `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D -configuration Debug build 2>&1 | tail -5` -- confirms clean build with no errors
  </verify>
  <done>Atlas constants updated to 2048x1024 with 16x32 grid = 512 slots. Project builds cleanly. All 500 airports can be rasterized into the atlas and rendered with distance culling.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Build succeeds: `xcodebuild -project AirplaneTracker3D.xcodeproj -scheme AirplaneTracker3D build` completes without errors
2. Airport count: `python3 -c "import json; print(len(json.load(open('AirplaneTracker3D/Data/airports.json'))))"` shows ~500
3. Berlin present: `python3 -c "import json; d=json.load(open('AirplaneTracker3D/Data/airports.json')); ber=[a for a in d if a['iata']=='BER']; print(ber)"` shows Berlin Brandenburg
4. Atlas can hold all airports: maxSlots (512) >= airport count (~500)
5. Search works automatically -- AirportSearchViewModel.swift needs no changes since it loads the same JSON format and filters by name/IATA/ICAO contains query
</verification>

<success_criteria>
- airports.json contains 480-520 major worldwide airports with balanced global coverage
- Berlin Brandenburg (BER/EDDB) is in the database and searchable
- All 99 original airports are preserved
- JSON format is unchanged (icao, iata, name, lat, lon, type)
- AirportLabelManager atlas supports 512 slots (2048x1024 texture)
- Project builds without errors
- No changes to AirportSearchViewModel.swift or AircraftModel.swift (data format unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/17-expanded-airport-database/17-01-SUMMARY.md`
</output>
